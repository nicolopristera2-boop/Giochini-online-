<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Avventura Pixel - ROGUE EDITION</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * { box-sizing: border-box; }

        body { 
            font-family: 'Press Start 2P', cursive; 
            margin: 0; padding: 0;
            background-color: #111; color: #fff; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden; 
            user-select: none; touch-action: none; overscroll-behavior-y: none; 
        }

        .game-container {
            position: relative; width: 800px; height: 600px;
            background-color: #000; border: 4px solid #444; border-radius: 4px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow: hidden;
            display: flex; flex-direction: column;
        }

        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        .ui-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50;
        }
        .hidden { display: none !important; }

        h2 { color: #e74c3c; margin-bottom: 40px; text-shadow: 4px 4px #000; font-size: 1.5rem; text-align: center; line-height: 2rem;}
        .char-grid { display: flex; gap: 40px; }
        .char-btn { font-size: 3rem; background: #222; border: 4px solid #fff; padding: 20px; cursor: pointer; transition: 0.2s; }
        .char-btn:hover { transform: scale(1.1); border-color: #e74c3c; color: #e74c3c; }

        input { font-family: 'Press Start 2P'; padding: 15px; font-size: 1rem; background: #222; color: #fff; border: 2px solid #fff; text-align: center; margin-bottom: 20px; outline: none; }
        .btn-start { font-family: 'Press Start 2P'; padding: 15px 30px; background: #e74c3c; color: #fff; border: 4px solid #fff; cursor: pointer; border-radius: 4px; }

        /* HUD Livello */
        #level-hud {
            position: absolute; top: 10px; left: 10px; color: white; z-index: 10;
            font-size: 16px; text-shadow: 2px 2px 0 #000; pointer-events: none;
        }

        /* Dialog Box */
        #dialogBox {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; min-height: 80px; 
            background: rgba(0, 0, 0, 0.9); border: 4px solid #fff; border-radius: 8px;
            padding: 20px; font-size: 14px; line-height: 22px; text-align: left;
            display: none; z-index: 40; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        #mobileControls { display: none; }
        .back-btn { position: absolute; top: 10px; right: 10px; text-decoration: none; color: #aaa; font-size: 10px; z-index: 60; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 4px; }

        @media (max-width: 850px) {
            body { background-color: #c0c0c0; justify-content: flex-start; }
            .game-container { width: 100%; height: 100dvh; border: none; border-radius: 0; background-color: #c0c0c0; }
            .screen-bezel {
                background-color: #555; border-radius: 10px 10px 40px 10px; margin: 5px 10px 0 10px; 
                flex: 1; display: flex; justify-content: center; align-items: center; padding: 15px; position: relative;
                box-shadow: inset 2px 2px 5px rgba(0,0,0,0.6);
            }
            canvas { background-color: #111; border: 4px solid #222; width: 100%; height: 100%; object-fit: contain; }
            #mobileControls {
                display: flex; width: 100%; height: auto; min-height: 220px;
                justify-content: space-between; align-items: center;
                padding: 10px 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom));
                background: #c0c0c0; flex-shrink: 0; 
            }
            .d-pad { position: relative; width: 130px; height: 130px; }
            .d-btn { position: absolute; background: #222; border: none; width: 42px; height: 42px; box-shadow: 0 4px 0 #000; border-radius: 4px; }
            .d-btn:active { transform: translate(0, 4px); box-shadow: none; background: #444; }
            #btnUp { top: 0; left: 44px; } #btnDown { bottom: 0; left: 44px; }
            #btnLeft { top: 44px; left: 0; } #btnRight { top: 44px; right: 0; }
            .d-center { position: absolute; top: 44px; left: 44px; width: 42px; height: 42px; background: #222; }
            .action-area { transform: rotate(-15deg); display: flex; gap: 20px; margin-bottom: 20px; }
            .a-btn { width: 60px; height: 60px; border-radius: 50%; background: #8f1c3f; border: none; box-shadow: 2px 4px 0 #4a0f25; color: rgba(255,255,255,0.2); font-weight: bold; font-size: 1.2rem; }
            .a-btn:active { transform: translate(2px, 4px); box-shadow: none; }
            .brand { position: absolute; bottom: calc(10px + env(safe-area-inset-bottom)); right: 20px; font-family: sans-serif; font-style: italic; color: #666; font-weight: bold; font-size: 12px; opacity: 0.6; letter-spacing: 1px;}
            #dialogBox { width: 95%; bottom: 10px; font-size: 12px; padding: 15px; }
        }
    </style>
</head>
<body>

<div class="game-container">
    <div class="screen-bezel">
        <div id="level-hud">LIVELLO: 1</div>
        <a href="index.html" class="back-btn">EXIT</a>
        
        <div id="screenSelection" class="ui-screen">
            <h2>ROGUE PIXEL<br>ADVENTURE</h2>
            <p style="margin-bottom:20px; color:#aaa; font-size:0.8rem">Generazione Procedurale Attiva</p>
            <div class="char-grid">
                <div class="char-btn" onclick="selectChar('ðŸ‘¦')">ðŸ‘¦</div>
                <div class="char-btn" onclick="selectChar('ðŸ‘§')">ðŸ‘§</div>
            </div>
        </div>
        
        <div id="screenName" class="ui-screen hidden">
            <h2>NOME EROE</h2>
            <input type="text" id="playerNameInput" placeholder="NOME" maxlength="8">
            <button class="btn-start" onclick="startGame()">ENTRA NEL DUNGEON</button>
        </div>

        <div id="dialogBox"></div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>

    <div id="mobileControls">
        <div class="d-pad">
            <div class="d-center"></div>
            <button id="btnUp" class="d-btn"></button>
            <button id="btnDown" class="d-btn"></button>
            <button id="btnLeft" class="d-btn"></button>
            <button id="btnRight" class="d-btn"></button>
        </div>
        <div class="brand">NINTENDO GAME BOY</div>
        <div class="action-area">
            <button class="a-btn">B</button>
            <button id="btnAction" class="a-btn">A</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const dialogBox = document.getElementById('dialogBox');
    const levelHud = document.getElementById('level-hud');

    let isPlaying = false;
    let dialogTimer = null;
    let gameTime = 0;
    
    // --- STATO DEL GIOCO E DEL GIOCATORE ---
    let player = { x: 400, y: 300, w: 28, h: 28, speed: 6, sprite: "ðŸ‘¦", name: "Link", facing: 1 };
    const keys = {};

    let state = {
        level: 1,
        hasKey: false,      // Chiave del livello corrente
        hasBoots: false,    // Persistente
        hasFlashlight: false, // Persistente
        hasGoggles: false   // Persistente
    };

    // Dati della stanza corrente (Generati proceduralmente)
    let currentRoom = {
        name: "",
        bgType: "",
        objects: [],
        darkness: false
    };

    // --- GENERATORE PROCEDURALE ---
    
    function generateLevel(level) {
        state.hasKey = false; // Reset chiave per nuovo livello
        levelHud.innerText = "LIVELLO: " + level;

        // 1. Scegli un tema
        const themes = ["wood", "stone", "tile", "tech", "wood_old"];
        // PiÃ¹ vai avanti, piÃ¹ Ã¨ probabile trovare temi "duri" come stone o tech
        let themeIndex = Math.min(Math.floor(Math.random() * (2 + level * 0.5)), themes.length - 1);
        let theme = themes[themeIndex]; 
        if(level % 5 === 0) theme = "tech"; // Ogni 5 livelli tema boss/tech

        // 2. Setup Base Stanza
        currentRoom = {
            name: "PIANO " + level + " - " + theme.toUpperCase(),
            bgType: theme,
            objects: [],
            darkness: (level > 6 && Math.random() > 0.5) // Dal livello 7 puÃ² essere buio
        };

        // 3. Aggiungi Muri Perimetrali (Sempre presenti)
        addObj(0, 0, 800, 50, "wall"); // Top
        addObj(0, 550, 800, 50, "wall"); // Bottom
        addObj(0, 0, 50, 600, "wall"); // Left
        addObj(750, 0, 50, 600, "wall"); // Right

        // 4. Posiziona Giocatore e Uscita
        player.x = 100; player.y = 300; // Start a sinistra
        
        // Porta di uscita (a destra)
        addObj(750, 250, 50, 100, "door", { req: "hasKey" });

        // 5. Genera Ostacoli Interni (DifficoltÃ  Crescente)
        let numObstacles = 2 + level * 2; // PiÃ¹ livelli, piÃ¹ roba
        if (numObstacles > 15) numObstacles = 15;

        for(let i=0; i<numObstacles; i++) {
            let type = "crate";
            let rand = Math.random();
            
            // VarietÃ  in base al tema
            if(theme === "wood" || theme === "wood_old") {
                if(rand > 0.7) type = "table";
                else if(rand > 0.5) type = "wall_hedge"; // Siepi in casa? Magari piante
                else type = "shelf";
            } else if (theme === "tech") {
                if(rand > 0.6) type = "serverRack";
                else if(rand > 0.4) type = "gen";
                else type = "pipe";
            } else {
                if(rand > 0.8) type = "rock"; // Muri interni
                else type = "wall";
            }

            // Pericoli (da livello 4 in su)
            if (level >= 4 && Math.random() > 0.8) type = "acid"; 
            if (level >= 8 && Math.random() > 0.8) type = "laser";

            // Posizione Random (Griglia 50x50, evitando spawn e exit)
            let rx = 100 + Math.floor(Math.random() * 12) * 50; // tra 100 e 700
            let ry = 100 + Math.floor(Math.random() * 8) * 50;  // tra 100 e 500
            
            // Dimensioni variabili
            let rw = 50; let rh = 50;
            if(type === "wall" || type === "shelf" || type === "acid") { 
                if(Math.random()>0.5) rw = 100; else rh = 100; 
            }

            addObj(rx, ry, rw, rh, type);
        }

        // 6. Piazza la CHIAVE (Obbligatoria)
        // Cerca un posto libero
        let keyX, keyY;
        let safe = false;
        while(!safe) {
            keyX = 150 + Math.random() * 500;
            keyY = 100 + Math.random() * 400;
            safe = true;
            // Controllo sovrapposizione molto semplice
            for(let o of currentRoom.objects) {
                if(checkRect(keyX, keyY, 40, 40, o)) safe = false;
            }
        }
        // Metto la chiave in un baule o per terra
        let lootType = (level % 3 === 0) ? "goldChest" : "chest";
        addObj(keyX, keyY, 50, 40, lootType, { contains: "key" });

        // 7. Oggetti Speciali (Aiuti) - Rari
        if(level === 3 && !state.hasBoots) spawnItem("boots");
        if(level === 5 && !state.hasFlashlight) spawnItem("flashlight");
        if(level === 7 && !state.hasGoggles) spawnItem("goggles");
    }

    function spawnItem(itemType) {
        let ix = 300 + Math.random() * 200;
        let iy = 200 + Math.random() * 200;
        addObj(ix, iy, 40, 40, itemType, { pickup: true });
    }

    function addObj(x, y, w, h, type, props = {}) {
        let obj = { x, y, w, h, type, solid: true, ...props };
        // Eccezioni soliditÃ 
        if(type === "rug" || type === "flower" || type === "acid" || type === "laser" || type === "cobweb" || props.pickup) {
            obj.solid = false;
        }
        currentRoom.objects.push(obj);
    }

    // --- LOGICA GIOCO ---

    function checkRect(x, y, w, h, obj) {
        return (x < obj.x + obj.w && x + w > obj.x && y < obj.y + obj.h && y + h > obj.y);
    }

    function checkCollision(nx, ny) {
        // Bordi canvas
        if (nx < 0 || nx > 800 - player.w || ny < 0 || ny > 600 - player.h) return true;
        
        for (let obj of currentRoom.objects) {
            if (obj.pickedUp) continue; // Ignora oggetti raccolti
            if (obj.solid) {
                if (nx < obj.x + obj.w && nx + player.w > obj.x &&
                    ny < obj.y + obj.h && ny + player.h > obj.y) {
                    return true;
                }
            }
        }
        return false;
    }

    function checkHazards() {
        let px = player.x + player.w/2; let py = player.y + player.h/2;
        for (let obj of currentRoom.objects) {
            if (obj.pickedUp) continue;
            
            if (obj.type === "acid" && !state.hasBoots) {
                if (px > obj.x && px < obj.x + obj.w && py > obj.y && py < obj.y + obj.h) {
                    // Respawn inizio stanza
                    player.x = 100; player.y = 300; 
                    showDialog("AHHH! L'acido brucia! (Servono stivali)");
                }
            }
            if (obj.type === "laser") {
                // Laser colpisce se non hai occhiali per vederli (o anche se li vedi e li tocchi)
                if (px > obj.x && px < obj.x + obj.w && py > obj.y && py < obj.y + obj.h) {
                    player.x = 100; player.y = 300; 
                    showDialog("BZZT! Colpito da un laser di sicurezza.");
                }
            }
        }
    }

    function interact() {
        let cx = player.x + player.w/2; let cy = player.y + player.h/2;
        for (let obj of currentRoom.objects) {
            if (obj.pickedUp) continue;
            let ox = obj.x + obj.w/2; let oy = obj.y + obj.h/2;
            if (Math.hypot(cx - ox, cy - oy) < 70) { 
                handleInteraction(obj); return; 
            }
        }
    }

    function handleInteraction(obj) {
        // Raccoglibili
        if(obj.pickup) {
            obj.pickedUp = true;
            if(obj.type === "flashlight") { state.hasFlashlight = true; showDialog("Hai preso la TORCIA!"); }
            else if(obj.type === "boots") { state.hasBoots = true; showDialog("Hai preso gli STIVALI!"); }
            else if(obj.type === "goggles") { state.hasGoggles = true; showDialog("Hai preso il VISORE TERMICO!"); }
            return;
        }

        // Bauli
        if(obj.type.includes("chest")) {
            if(obj.opened) { showDialog("GiÃ  aperto."); return; }
            obj.opened = true;
            // Cambia grafica (semplice trucco, in draw guarderemo 'opened')
            if(obj.contains === "key") {
                state.hasKey = true;
                showDialog("Hai trovato la CHIAVE del livello!");
            } else {
                showDialog("Solo polvere...");
            }
            return;
        }

        // Porta (Uscita)
        if(obj.type === "door") {
            if(state.hasKey) {
                showDialog("La porta si apre! Livello completato.");
                state.level++;
                setTimeout(() => generateLevel(state.level), 1000);
            } else {
                showDialog("Chiusa. Devi trovare la chiave.");
            }
            return;
        }

        // Flavour text
        if(obj.type === "pc") showDialog("Un terminale antico...");
        if(obj.type === "gen") showDialog("Ronza leggermente.");
        if(obj.type === "shelf") showDialog("Libri ammuffiti.");
    }

    function showDialog(text) {
        dialogBox.innerText = text; dialogBox.style.display='block';
        if(dialogTimer) clearTimeout(dialogTimer);
        dialogTimer = setTimeout(()=>dialogBox.style.display='none', 3000);
    }

    // --- RENDERER (STILE 2.5D MIGLIORATO) ---
    function draw() {
        gameTime++;
        drawFloor(currentRoom.bgType);

        // Disegna oggetti "Floor"
        currentRoom.objects.forEach(obj => {
            if(["rug", "dirt", "acid", "flower"].includes(obj.type)) drawObject(obj);
        });

        // Buio
        if (currentRoom.darkness && !state.hasFlashlight) {
            ctx.fillStyle = "rgba(0,0,0,0.98)"; ctx.fillRect(0,0,800,600);
            let grad = ctx.createRadialGradient(player.x+14, player.y+14, 20, player.x+14, player.y+14, 120);
            grad.addColorStop(0, "rgba(0,0,0,0)"); grad.addColorStop(1, "rgba(0,0,0,1)");
            ctx.globalCompositeOperation = 'destination-out';
            ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(player.x+14, player.y+14, 120, 0, Math.PI*2); ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
        }

        // Sort Y per profonditÃ 
        let renderList = currentRoom.objects.filter(obj => !["rug", "dirt", "acid", "flower"].includes(obj.type));
        renderList.push({ ...player, isPlayer: true });
        renderList.sort((a,b) => (a.y + a.h) - (b.y + b.h));

        renderList.forEach(obj => {
            if (obj.pickedUp) return;
            if (obj.isPlayer) drawPlayer();
            else drawObject(obj); 
        });

        // Visore Goggles
        if (state.hasGoggles) {
            ctx.strokeStyle = "rgba(0, 255, 0, 0.3)"; ctx.lineWidth=1;
            for(let o of currentRoom.objects) { if(o.type==="laser") ctx.strokeRect(o.x, o.y, o.w, o.h); }
        }

        ctx.fillStyle = "#fff"; ctx.font = "20px 'Press Start 2P'"; ctx.textAlign = "left"; 
        ctx.fillText(currentRoom.name, 20, 40);
        
        // Inventario HUD
        let invText = "INV: ";
        if(state.hasKey) invText += "ðŸ”‘ ";
        if(state.hasBoots) invText += "ðŸ‘¢ ";
        if(state.hasFlashlight) invText += "ðŸ”¦ ";
        ctx.textAlign = "right"; ctx.fillText(invText, 780, 40);
    }

    function drawFloor(type) {
        let sz = 40;
        if (type === "wood" || type === "wood_old") {
            for(let y=0; y<600; y+=sz) for(let x=0; x<800; x+=sz) {
                ctx.fillStyle = (y%(sz*2)===0) ? "#5d4037" : "#4e342e"; ctx.fillRect(x, y, sz, sz);
                ctx.fillStyle="rgba(0,0,0,0.1)"; ctx.fillRect(x,y,sz,2);
            }
        } else if (type === "tile" || type === "tech") {
            sz = 50; 
            for(let y=0; y<600; y+=sz) for(let x=0; x<800; x+=sz) {
                let c1 = type==="tile"?"#ecf0f1":"#263238";
                let c2 = type==="tile"?"#bdc3c7":"#37474f";
                ctx.fillStyle = ((x/sz + y/sz)%2===0) ? c1 : c2; ctx.fillRect(x, y, sz, sz);
            }
        } else if (type === "stone") {
            ctx.fillStyle = "#424242"; ctx.fillRect(0,0,800,600);
            ctx.fillStyle = "rgba(0,0,0,0.2)"; for(let i=0; i<800; i+=50) ctx.fillRect(i, 0, 2, 600);
        }
    }

    function drawObject(obj) {
        ctx.save();
        
        // MURI 2.5D
        if (obj.type === "wall" || obj.type === "rock") {
            let colFace = obj.type==="wall"?"#616161":"#546e7a";
            let colTop = obj.type==="wall"?"#757575":"#78909c";
            ctx.fillStyle = colFace; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            ctx.fillStyle = colTop; ctx.fillRect(obj.x, obj.y, obj.w, 15);
            ctx.strokeStyle = "rgba(0,0,0,0.5)"; ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
            ctx.restore(); return;
        }
        
        // OMBRA
        if(!["acid", "rug", "flower"].includes(obj.type)) {
            ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.beginPath(); ctx.ellipse(obj.x + obj.w/2, obj.y + obj.h, obj.w/2, 6, 0, 0, Math.PI*2); ctx.fill();
        }

        // OGGETTI VARI
        if (obj.type.includes("chest")) {
            let col = obj.opened ? "#5d4037" : (obj.type==="goldChest"?"#f1c40f":"#8d6e63");
            ctx.fillStyle = col; ctx.fillRect(obj.x, obj.y+10, obj.w, obj.h-10); // Base
            if(!obj.opened) {
                ctx.fillStyle = "rgba(0,0,0,0.2)"; ctx.fillRect(obj.x, obj.y+10, obj.w, 5);
                ctx.fillStyle = col; ctx.filter="brightness(1.2)"; ctx.fillRect(obj.x, obj.y, obj.w, 15); // Coperchio chiuso
            } else {
                ctx.fillStyle = "#000"; ctx.fillRect(obj.x+5, obj.y+5, obj.w-10, 10); // Aperto dentro
            }
            ctx.filter="none"; ctx.strokeStyle="#000"; ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
        }
        else if(obj.type === "door") {
            ctx.fillStyle = state.hasKey ? "#27ae60" : "#c0392b"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            ctx.strokeStyle="#fff"; ctx.lineWidth=3; ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
            ctx.fillStyle="#fff"; ctx.font="10px Arial"; ctx.fillText("EXIT", obj.x+10, obj.y+obj.h/2);
        }
        else if (obj.type === "acid") {
            ctx.fillStyle = "rgba(46, 204, 113, 0.8)"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            if(gameTime%20<10) { ctx.fillStyle="#fff"; ctx.fillRect(obj.x+Math.random()*obj.w, obj.y+Math.random()*obj.h, 4, 4); }
        }
        else if (obj.type === "laser") {
            // Invisibili a meno che non hai visore (gestito in draw)
            // Se li tocchi muori
        }
        else if (obj.type === "crate") {
            ctx.fillStyle = "#a1887f"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            ctx.strokeStyle = "#5d4037"; ctx.lineWidth=2; ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
            ctx.beginPath(); ctx.moveTo(obj.x, obj.y); ctx.lineTo(obj.x+obj.w, obj.y+obj.h); ctx.stroke();
        }
        // Fallback per altri oggetti decorativi generati
        else if (obj.pickup) {
            // Oggetti raccoglibili
            ctx.fillStyle = "yellow"; ctx.beginPath(); ctx.arc(obj.x+obj.w/2, obj.y+obj.h/2, 10, 0, Math.PI*2); ctx.fill();
            if(obj.type==="boots") ctx.fillStyle="orange"; 
            if(obj.type==="flashlight") ctx.fillStyle="white";
            ctx.fill();
        }
        else {
            ctx.fillStyle = "#7f8c8d"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
        }
        ctx.restore();
    }

    function drawPlayer() {
        ctx.font = "32px serif"; ctx.textAlign = "center"; ctx.save();
        ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.beginPath(); ctx.ellipse(player.x+14, player.y+26, 10, 4, 0, 0, Math.PI*2); ctx.fill();
        let breathe = Math.sin(gameTime * 0.1) * 2;
        if (player.facing === -1) { ctx.translate(player.x+28, player.y + breathe); ctx.scale(-1, 1); ctx.fillText(player.sprite, 14, 28); } 
        else { ctx.fillText(player.sprite, player.x+14, player.y+28 + breathe); }
        ctx.restore();
    }

    // --- CONTROLLI ---
    window.addEventListener('keydown', e => { keys[e.code] = true; if(e.code==='Space' && isPlaying) interact(); });
    window.addEventListener('keyup', e => { keys[e.code] = false; });

    function bindTouch(id, code) {
        const btn = document.getElementById(id); if(!btn) return;
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[code] = true; if(code==='Space' && isPlaying) interact(); }, {passive: false});
        btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[code] = false; }, {passive: false});
        btn.addEventListener('mousedown', (e) => { keys[code] = true; if(code==='Space' && isPlaying) interact(); });
        btn.addEventListener('mouseup', (e) => { keys[code] = false; });
    }
    bindTouch('btnUp', 'ArrowUp'); bindTouch('btnDown', 'ArrowDown'); bindTouch('btnLeft', 'ArrowLeft'); bindTouch('btnRight', 'ArrowRight'); bindTouch('btnAction', 'Space');

    function update() {
        if (!isPlaying) return;
        gameTime++;
        let nx = player.x, ny = player.y;
        if (keys.ArrowUp) ny -= player.speed; if (keys.ArrowDown) ny += player.speed;
        if (keys.ArrowLeft) { nx -= player.speed; player.facing = -1; } if (keys.ArrowRight) { nx += player.speed; player.facing = 1; }
        if (!checkCollision(nx, player.y)) player.x = nx;
        if (!checkCollision(player.x, ny)) player.y = ny;
        checkHazards();
    }
    function loop() { update(); draw(); requestAnimationFrame(loop); }
    function selectChar(s) { player.sprite = s; document.getElementById('screenSelection').classList.add('hidden'); document.getElementById('screenName').classList.remove('hidden'); }
    function startGame() { 
        player.name = document.getElementById('playerNameInput').value || "Eroe"; 
        document.getElementById('screenName').classList.add('hidden'); 
        isPlaying = true; 
        generateLevel(1); // Genera primo livello
        loop(); 
    }
</script>
</body>
</html>
