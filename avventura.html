<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avventura Grafica</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üó∫Ô∏è</text></svg>">
    
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            background-color: #2c3e50; 
            color: #333; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .game-container {
            position: relative;
            width: 800px;
            height: 600px;
            background-color: #1a1a1a; /* Bordo scuro esterno */
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 4px solid #444;
        }

        /* --- UI Screens --- */
        .ui-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10;
        }

        .hidden { display: none !important; }

        h2 { margin-bottom: 30px; color: #00979D; font-size: 2.2rem; text-transform: uppercase; letter-spacing: 2px; }

        /* Griglia Personaggi */
        .char-grid { display: flex; gap: 30px; }
        .char-option {
            font-size: 4rem; cursor: pointer; padding: 25px;
            border: 3px solid #eee; border-radius: 20px;
            transition: 0.3s; background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .char-option:hover { transform: translateY(-10px); border-color: #00979D; box-shadow: 0 10px 20px rgba(0, 151, 157, 0.3); }

        input[type="text"] {
            padding: 15px; font-size: 1.2rem; border: 2px solid #ddd;
            border-radius: 8px; width: 300px; text-align: center; margin-bottom: 30px;
            outline: none; transition: 0.3s;
        }
        input[type="text"]:focus { border-color: #00979D; }

        .btn-start {
            padding: 15px 50px; background-color: #00979D; color: white;
            border: none; border-radius: 30px; font-size: 1.2rem; font-weight: bold;
            cursor: pointer; transition: 0.3s; box-shadow: 0 4px 0 #007a80;
        }
        .btn-start:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #007a80; }
        .btn-start:active { transform: translateY(2px); box-shadow: 0 0 0 #007a80; }

        canvas { display: block; }

        .back-btn {
            position: absolute; top: 15px; left: 15px;
            text-decoration: none; color: #333; background: white;
            padding: 8px 15px; border-radius: 20px; z-index: 20;
            font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        .back-btn:hover { transform: scale(1.05); }
    </style>
</head>
<body>

<div class="game-container">
    <a href="index.html" class="back-btn" data-i18n="backHome">üè† Home</a>

    <div id="screenSelection" class="ui-screen">
        <h2 data-i18n="chooseChar">Scegli il tuo Personaggio</h2>
        <div class="char-grid">
            <div class="char-option" onclick="selectChar('üë¶')">üë¶</div>
            <div class="char-option" onclick="selectChar('üëß')">üëß</div>
            <div class="char-option" onclick="selectChar('üïµÔ∏è')">üïµÔ∏è</div>
            <div class="char-option" onclick="selectChar('ü§ñ')">ü§ñ</div>
        </div>
    </div>

    <div id="screenName" class="ui-screen hidden">
        <h2 data-i18n="enterName">Inserisci il tuo Nome</h2>
        <input type="text" id="playerNameInput" placeholder="...">
        <button class="btn-start" onclick="startGame()" data-i18n="startAdv">Inizia</button>
    </div>

    <canvas id="gameCanvas" width="800" height="600"></canvas>
</div>

<script src="lingue.js"></script>

<script>
    window.isGamePage = true;

    // --- VARIABILI ---
    let player = { x: 400, y: 300, w: 40, h: 40, speed: 5, sprite: "üë¶", name: "Player" };
    let isPlaying = false;
    const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false };

    // Oggetti della stanza (Arredamento)
    // type: determina come viene disegnato
    const furniture = [
        { x: 100, y: 100, w: 200, h: 100, type: "table" },
        { x: 500, y: 400, w: 180, h: 80,  type: "sofa" },
        { x: 650, y: 50,  w: 100, h: 200, type: "bookshelf" },
        { x: 50,  y: 450, w: 60,  h: 60,  type: "plant" }
    ];

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const inputField = document.getElementById('playerNameInput');
    
    // --- GESTIONE UI ---
    function selectChar(emoji) {
        player.sprite = emoji;
        document.getElementById('screenSelection').classList.add('hidden');
        document.getElementById('screenName').classList.remove('hidden');
        inputField.placeholder = t('placeholderName');
        inputField.focus();
    }

    function startGame() {
        const name = inputField.value.trim();
        player.name = name || "Eroe";
        document.getElementById('screenName').classList.add('hidden');
        isPlaying = true;
        gameLoop();
    }

    window.addEventListener('keydown', e => { if(keys.hasOwnProperty(e.key)) keys[e.key] = true; });
    window.addEventListener('keyup', e => { if(keys.hasOwnProperty(e.key)) keys[e.key] = false; });

    // --- LOGICA COLLISIONI ---
    function checkCollision(newX, newY) {
        const pRect = { x: newX, y: newY, w: player.w, h: player.h };

        // Muri (considerando lo spessore del muro 50px in alto)
        if (newX < 20 || newX + player.w > canvas.width - 20 || 
            newY < 70 || newY + player.h > canvas.height - 20) {
            return true;
        }

        // Mobili
        for (let obj of furniture) {
            // Hitbox un po' pi√π piccola dell'oggetto grafico per effetto profondit√†
            let hitX = obj.x + 10;
            let hitY = obj.y + 20; // Si pu√≤ camminare "davanti" ai piedi del mobile
            let hitW = obj.w - 20;
            let hitH = obj.h - 30;

            if (pRect.x < hitX + hitW && pRect.x + pRect.w > hitX &&
                pRect.y < hitY + hitH && pRect.y + pRect.h > hitY) {
                return true; 
            }
        }
        return false;
    }

    function update() {
        if (!isPlaying) return;
        let nextX = player.x;
        let nextY = player.y;

        if (keys.ArrowUp) nextY -= player.speed;
        if (keys.ArrowDown) nextY += player.speed;
        if (keys.ArrowLeft) nextX -= player.speed;
        if (keys.ArrowRight) nextX += player.speed;

        if (!checkCollision(nextX, player.y)) player.x = nextX;
        if (!checkCollision(player.x, nextY)) player.y = nextY;
    }

    // --- FUNZIONI DI DISEGNO STILIZZATO ---

    function drawRoom() {
        // 1. Pavimento (Parquet)
        ctx.fillStyle = "#d7ccc8"; // Base chiara
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Righe del legno
        ctx.strokeStyle = "#a1887f";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=0; i<canvas.height; i+=30) {
            ctx.moveTo(0, i); ctx.lineTo(canvas.width, i);
        }
        // Assi verticali sfalsate
        for(let row=0; row<canvas.height/30; row++) {
            let offset = (row % 2 === 0) ? 0 : 50;
            for(let j=offset; j<canvas.width; j+=100) {
                ctx.moveTo(j, row*30); ctx.lineTo(j, row*30+30);
            }
        }
        ctx.stroke();

        // 2. Tappeto (Sotto al tavolo)
        ctx.fillStyle = "#80cbc4"; // Verde acqua
        ctx.beginPath();
        ctx.ellipse(200, 150, 120, 70, 0, 0, Math.PI*2);
        ctx.fill();
        ctx.strokeStyle = "#4db6ac";
        ctx.lineWidth = 4;
        ctx.stroke();

        // 3. Muri
        const wallH = 50;
        ctx.fillStyle = "#eceff1"; // Muro Grigio chiaro
        ctx.fillRect(0, 0, canvas.width, wallH);
        // Battiscopa
        ctx.fillStyle = "#5d4037"; // Marrone scuro
        ctx.fillRect(0, wallH-10, canvas.width, 10);
        ctx.fillRect(0, wallH, 10, canvas.height); // Lato SX
        ctx.fillRect(canvas.width-10, wallH, 10, canvas.height); // Lato DX
        ctx.fillRect(0, canvas.height-10, canvas.width, 10); // Bordo basso
    }

    function drawFurniture(obj) {
        ctx.save();
        // Ombra generica sotto i mobili
        ctx.fillStyle = "rgba(0,0,0,0.2)";
        ctx.fillRect(obj.x + 10, obj.y + obj.h - 10, obj.w - 20, 15);

        if (obj.type === "table") {
            // Tavolo legno
            ctx.fillStyle = "#8d6e63"; // Marrone
            ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            // Tovaglia
            ctx.fillStyle = "#fff9c4"; // Crema
            ctx.fillRect(obj.x + 20, obj.y + 10, obj.w - 40, obj.h - 20);
            // Dettaglio sul tavolo (es. una tazza)
            ctx.beginPath();
            ctx.arc(obj.x + 60, obj.y + 40, 8, 0, Math.PI*2);
            ctx.fillStyle = "white"; ctx.fill();
            ctx.fillStyle = "#6d4c41"; ctx.fill(); // Caff√®
        } 
        else if (obj.type === "sofa") {
            // Divano Rosso
            ctx.fillStyle = "#ef5350"; 
            // Schienale
            ctx.fillRect(obj.x, obj.y, obj.w, 30);
            // Seduta
            ctx.fillRect(obj.x, obj.y+30, obj.w, obj.h-30);
            // Braccioli
            ctx.fillStyle = "#d32f2f";
            ctx.fillRect(obj.x, obj.y+20, 20, obj.h-20);
            ctx.fillRect(obj.x + obj.w - 20, obj.y+20, 20, obj.h-20);
            // Cuscini
            ctx.fillStyle = "#ffcdd2";
            ctx.fillRect(obj.x + 30, obj.y + 35, 40, 30);
            ctx.fillRect(obj.x + 110, obj.y + 35, 40, 30);
        }
        else if (obj.type === "bookshelf") {
            // Struttura
            ctx.fillStyle = "#4e342e";
            ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            // Ripiani e Libri
            const colors = ["#e57373", "#64b5f6", "#81c784", "#fff176"];
            for(let i=obj.y+20; i<obj.y+obj.h; i+=40) {
                // Ripiano
                ctx.fillStyle = "#3e2723";
                ctx.fillRect(obj.x+5, i, obj.w-10, 5);
                // Libri casuali
                for(let j=obj.x+10; j<obj.x+obj.w-15; j+=15) {
                    ctx.fillStyle = colors[Math.floor(Math.random()*colors.length)];
                    ctx.fillRect(j, i-25, 10, 25);
                }
            }
        }
        else if (obj.type === "plant") {
            // Vaso
            ctx.fillStyle = "#d84315";
            ctx.beginPath();
            ctx.arc(obj.x + obj.w/2, obj.y + obj.h/2 + 10, 15, 0, Math.PI*2);
            ctx.fill();
            // Foglie
            ctx.fillStyle = "#2e7d32";
            ctx.beginPath();
            ctx.arc(obj.x + obj.w/2, obj.y + obj.h/2 - 10, 20, 0, Math.PI*2);
            ctx.arc(obj.x + obj.w/2 - 10, obj.y + obj.h/2, 15, 0, Math.PI*2);
            ctx.arc(obj.x + obj.w/2 + 10, obj.y + obj.h/2, 15, 0, Math.PI*2);
            ctx.fill();
        }
        ctx.restore();
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. Stanza
        drawRoom();

        // 2. Info Stanza (UI)
        ctx.fillStyle = "#333";
        ctx.font = "bold 20px 'Segoe UI'";
        ctx.textAlign = "center";
        ctx.fillText("üìç " + t('roomName'), canvas.width/2, 35);

        // 3. Mobili (Disegnati prima del player se sono "sopra" y, logica base)
        furniture.forEach(obj => drawFurniture(obj));

        // 4. Giocatore
        ctx.font = "50px Arial";
        ctx.textAlign = "center";
        
        // Ombra giocatore
        ctx.fillStyle = "rgba(0,0,0,0.2)";
        ctx.beginPath();
        ctx.ellipse(player.x + 20, player.y + 45, 15, 5, 0, 0, Math.PI*2);
        ctx.fill();

        // Sprite
        ctx.fillText(player.sprite, player.x + 20, player.y + 40);
        
        // Label Nome
        ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
        ctx.fillRect(player.x - 20, player.y - 20, 80, 20);
        ctx.fillStyle = "#333";
        ctx.font = "bold 12px Arial";
        ctx.fillText(player.name, player.x + 20, player.y - 6);
    }

    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }
</script>

</body>
</html>
