<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rogue Pixel - International</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * { box-sizing: border-box; }

        body { 
            font-family: 'Press Start 2P', cursive; 
            margin: 0; padding: 0;
            background-color: #111; color: #fff; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden; 
            user-select: none; touch-action: none; overscroll-behavior-y: none; 
        }

        .game-container {
            position: relative; width: 800px; height: 600px;
            background-color: #000; border: 4px solid #444; border-radius: 4px;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); overflow: hidden;
            display: flex; flex-direction: column;
        }

        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        .ui-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); color: #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50;
        }
        .hidden { display: none !important; }

        h2 { color: #e74c3c; margin-bottom: 30px; text-shadow: 4px 4px #000; font-size: 1.5rem; text-align: center; line-height: 2rem;}
        
        .char-grid { display: flex; gap: 40px; margin-bottom: 30px; }
        .char-btn { font-size: 3rem; background: #222; border: 4px solid #fff; padding: 20px; cursor: pointer; transition: 0.2s; }
        .char-btn:hover { transform: scale(1.1); border-color: #e74c3c; color: #e74c3c; }

        input { font-family: 'Press Start 2P'; padding: 15px; font-size: 1rem; background: #222; color: #fff; border: 2px solid #fff; text-align: center; margin-bottom: 20px; outline: none; }
        .btn-start { font-family: 'Press Start 2P'; padding: 15px 30px; background: #e74c3c; color: #fff; border: 4px solid #fff; cursor: pointer; border-radius: 4px; }

        /* LANGUAGE SWITCHER STYLE */
        .lang-switcher { margin-top: 40px; display: flex; gap: 10px; }
        .lang-btn { 
            background: #222; border: 2px solid #555; color: #888; 
            padding: 8px 12px; font-family: 'Press Start 2P'; cursor: pointer; font-size: 10px; 
        }
        .lang-btn.active { border-color: #e74c3c; color: white; }

        /* HUD */
        #hud-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; padding: 15px;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .top-hud { display: flex; justify-content: space-between; width: 100%; }
        .hud-text { font-size: 16px; text-shadow: 2px 2px 0 #000; color: white; }
        .hearts { color: #e74c3c; font-size: 20px; text-shadow: 2px 2px 0 #000; }
        
        /* Dialog Box */
        #dialogBox {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; min-height: 80px; 
            background: rgba(0, 0, 0, 0.9); border: 4px solid #fff; border-radius: 8px;
            padding: 20px; font-size: 14px; line-height: 22px; text-align: left;
            display: none; z-index: 40; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        /* Schermata Game Over */
        #gameOverScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(139, 0, 0, 0.8); z-index: 60;
            flex-direction: column; align-items: center; justify-content: center;
            display: none;
        }

        #mobileControls { display: none; }
        .back-btn { pointer-events: auto; text-decoration: none; color: #aaa; font-size: 10px; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 4px; }

        @media (max-width: 850px) {
            body { background-color: #c0c0c0; justify-content: flex-start; }
            .game-container { width: 100%; height: 100dvh; border: none; border-radius: 0; background-color: #c0c0c0; }
            .screen-bezel {
                background-color: #555; border-radius: 10px 10px 40px 10px; margin: 5px 10px 0 10px; 
                flex: 1; display: flex; justify-content: center; align-items: center; padding: 0; position: relative;
                box-shadow: inset 2px 2px 5px rgba(0,0,0,0.6); overflow: hidden;
            }
            canvas { background-color: #111; width: 100%; height: 100%; object-fit: contain; }
            #mobileControls {
                display: flex; width: 100%; height: auto; min-height: 220px;
                justify-content: space-between; align-items: center;
                padding: 10px 20px; padding-bottom: calc(20px + env(safe-area-inset-bottom));
                background: #c0c0c0; flex-shrink: 0; 
            }
            .d-pad { position: relative; width: 130px; height: 130px; }
            .d-btn { position: absolute; background: #222; border: none; width: 42px; height: 42px; box-shadow: 0 4px 0 #000; border-radius: 4px; }
            .d-btn:active { transform: translate(0, 4px); box-shadow: none; background: #444; }
            #btnUp { top: 0; left: 44px; } #btnDown { bottom: 0; left: 44px; }
            #btnLeft { top: 44px; left: 0; } #btnRight { top: 44px; right: 0; }
            .d-center { position: absolute; top: 44px; left: 44px; width: 42px; height: 42px; background: #222; }
            .action-area { transform: rotate(-15deg); display: flex; gap: 20px; margin-bottom: 20px; }
            .a-btn { width: 60px; height: 60px; border-radius: 50%; background: #8f1c3f; border: none; box-shadow: 2px 4px 0 #4a0f25; color: rgba(255,255,255,0.2); font-weight: bold; font-size: 1.2rem; }
            .a-btn:active { transform: translate(2px, 4px); box-shadow: none; }
            .brand { position: absolute; bottom: calc(10px + env(safe-area-inset-bottom)); right: 20px; font-family: sans-serif; font-style: italic; color: #666; font-weight: bold; font-size: 12px; opacity: 0.6; letter-spacing: 1px;}
            #dialogBox { width: 95%; bottom: 10px; font-size: 12px; padding: 15px; }
        }
    </style>
</head>
<body>

<div class="game-container">
    <div class="screen-bezel">
        <div id="hud-layer">
            <div class="top-hud">
                <div class="hud-text" id="level-text">LVL 1</div>
                <div class="hearts" id="life-text">‚ù§‚ù§‚ù§</div>
                <div class="hud-text" id="score-text">PTS: 0</div>
            </div>
            <a href="index.html" class="back-btn" data-i18n="ui_exit" style="align-self: flex-end;">EXIT</a>
        </div>

        <div id="gameOverScreen">
            <h1 style="color:red; font-size:3rem; text-shadow:4px 4px 0 #000;" data-i18n="go_title">GAME OVER</h1>
            <p id="finalStats" style="margin:20px 0; font-size:1.2rem; color:white; text-shadow:2px 2px 0 #000;"></p>
            <button class="btn-start" onclick="restartGame()" data-i18n="go_retry">RIPROVA</button>
        </div>

        <div id="screenSelection" class="ui-screen">
            <h2 data-i18n="title_main">ROGUE PIXEL<br>ENDLESS</h2>
            <div class="char-grid">
                <div class="char-btn" onclick="selectChar('üë¶')">üë¶</div>
                <div class="char-btn" onclick="selectChar('üëß')">üëß</div>
            </div>
            <p style="color:#aaa; font-size:0.7rem; margin-top:20px;" data-i18n="subtitle">Livelli infiniti</p>
            
            <div class="lang-switcher">
                <button class="lang-btn active" onclick="setLanguage('it')">IT</button>
                <button class="lang-btn" onclick="setLanguage('en')">EN</button>
                <button class="lang-btn" onclick="setLanguage('sk')">SK</button>
            </div>
        </div>
        
        <div id="screenName" class="ui-screen hidden">
            <h2 data-i18n="title_who">CHI SEI?</h2>
            <input type="text" id="playerNameInput" placeholder="EREO" maxlength="8">
            <button class="btn-start" onclick="startGame()" data-i18n="btn_enter">ENTRA</button>
        </div>

        <div id="dialogBox"></div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>

    <div id="mobileControls">
        <div class="d-pad">
            <div class="d-center"></div>
            <button id="btnUp" class="d-btn"></button>
            <button id="btnDown" class="d-btn"></button>
            <button id="btnLeft" class="d-btn"></button>
            <button id="btnRight" class="d-btn"></button>
        </div>
        <div class="brand">NINTENDO GAME BOY</div>
        <div class="action-area">
            <button class="a-btn">B</button>
            <button id="btnAction" class="a-btn">A</button>
        </div>
    </div>
</div>

<script>
    // --- 0. SISTEMA DI TRADUZIONE ---
    const translations = {
        it: {
            title_main: "ROGUE PIXEL<br>ENDLESS",
            subtitle: "Livelli infiniti",
            title_who: "CHI SEI?",
            input_placeholder: "EROE",
            btn_enter: "ENTRA",
            ui_exit: "ESCI",
            go_title: "GAME OVER",
            go_retry: "RIPROVA",
            hud_lvl: "LIV",
            hud_pts: "PTS",
            stat_lvl: "Livello",
            stat_pts: "Punti",
            msg_floor: "PIANO",
            msg_dark: "(OSCURO)",
            msg_ouch: "AHIA! Danno subito!",
            msg_potion: "Pozione! +1 Cuore",
            msg_boots: "Stivali presi! (Acido OK)",
            msg_flash: "Torcia presa! (Luce)",
            msg_goggles: "Visore preso! (Laser)",
            msg_key: "CHIAVE TROVATA!",
            msg_gold: "Monete d'oro!",
            msg_win: "Livello Completato!",
            msg_lock: "Chiusa. Trova la chiave."
        },
        en: {
            title_main: "ROGUE PIXEL<br>ENDLESS",
            subtitle: "Infinite Levels",
            title_who: "WHO ARE YOU?",
            input_placeholder: "HERO",
            btn_enter: "ENTER",
            ui_exit: "EXIT",
            go_title: "GAME OVER",
            go_retry: "RETRY",
            hud_lvl: "LVL",
            hud_pts: "PTS",
            stat_lvl: "Level",
            stat_pts: "Score",
            msg_floor: "FLOOR",
            msg_dark: "(DARK)",
            msg_ouch: "OUCH! Damage taken!",
            msg_potion: "Potion! +1 Heart",
            msg_boots: "Boots taken! (Acid OK)",
            msg_flash: "Flashlight taken! (Light)",
            msg_goggles: "Goggles taken! (Lasers)",
            msg_key: "KEY FOUND!",
            msg_gold: "Gold coins!",
            msg_win: "Level Complete!",
            msg_lock: "Locked. Find the key."
        },
        sk: {
            title_main: "ROGUE PIXEL<br>NEKONEƒåN√ù",
            subtitle: "Nekoneƒçn√© √∫rovne",
            title_who: "KTO SI?",
            input_placeholder: "HRDINA",
            btn_enter: "VST√öPI≈§",
            ui_exit: "KONIEC",
            go_title: "KONIEC HRY",
            go_retry: "SK√öSI≈§ ZNOVA",
            hud_lvl: "√öRO",
            hud_pts: "BODY",
            stat_lvl: "√örove≈à",
            stat_pts: "Body",
            msg_floor: "POSCHODIE",
            msg_dark: "(TMY)",
            msg_ouch: "AU! Z√°sah!",
            msg_potion: "Elix√≠r! +1 Srdce",
            msg_boots: "Top√°nky! (Kyselina OK)",
            msg_flash: "Baterka! (Svetlo)",
            msg_goggles: "Okuliare! (Lasery)",
            msg_key: "KƒΩ√öƒå N√ÅJDEN√ù!",
            msg_gold: "Zlat√© mince!",
            msg_win: "√örove≈à dokonƒçen√°!",
            msg_lock: "Zamknut√©. N√°jdi kƒæ√∫ƒç."
        }
    };

    let curLang = 'it'; // Lingua di default

    function setLanguage(lang) {
        curLang = lang;
        // Aggiorna elementi DOM statici
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if(translations[lang][key]) el.innerHTML = translations[lang][key];
        });
        // Aggiorna placeholder input
        document.getElementById('playerNameInput').placeholder = translations[lang].input_placeholder;
        
        // Aggiorna stile bottoni
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.classList.remove('active');
            if(btn.innerText.toLowerCase() === lang) btn.classList.add('active');
        });

        // Aggiorna testi dinamici se il gioco √® in pausa o menu
        if(levelText) updateHUD();
    }
    // --- FINE LOGICA I18N ---

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const dialogBox = document.getElementById('dialogBox');
    const levelText = document.getElementById('level-text');
    const lifeText = document.getElementById('life-text');
    const scoreText = document.getElementById('score-text');
    const gameOverScreen = document.getElementById('gameOverScreen');

    let isPlaying = false;
    let dialogTimer = null;
    let gameTime = 0;
    
    let player = { x: 100, y: 300, w: 28, h: 28, speed: 6, sprite: "üë¶", name: "Link", facing: 1, invulnerable: 0 };
    const keys = {};

    let state = {
        level: 1,
        hp: 3,
        score: 0,
        hasKey: false,
        hasBoots: false,
        hasFlashlight: false,
        hasGoggles: false
    };

    let currentRoom = { name: "", bgType: "", objects: [], darkness: false };

    // --- GENERATORE DI LIVELLI ---
    function generateLevel(level) {
        state.hasKey = false;
        // TRADUZIONE DINAMICA: Uso il dizionario invece della stringa fissa
        levelText.innerText = translations[curLang].hud_lvl + " " + level;
        
        const themes = ["wood", "stone", "tile", "tech", "wood_old"];
        let themeIndex = (Math.floor((level-1)/2)) % themes.length; 
        let theme = themes[themeIndex];
        
        let darkChance = Math.min(0.8, (level - 5) * 0.1); 
        let isDark = Math.random() < darkChance;

        currentRoom = {
            // TRADUZIONE DINAMICA DEL NOME STANZA
            name: translations[curLang].msg_floor + " " + level + (isDark ? " " + translations[curLang].msg_dark : ""),
            bgType: theme,
            objects: [],
            darkness: isDark
        };

        // --- MURI PERIMETRALI ---
        addObj(0, 0, 800, 50, "wall"); // Top
        addObj(0, 550, 800, 50, "wall"); // Bottom
        addObj(0, 0, 50, 600, "wall"); // Left
        
        // --- FIX USCITA: Muro destro SPEZZATO ---
        addObj(750, 0, 50, 250, "wall"); // Pezzo sopra
        addObj(750, 350, 50, 250, "wall"); // Pezzo sotto
        // La porta √® nel buco (Y=250 a Y=350)
        addObj(750, 250, 50, 100, "door", { req: "hasKey" });

        player.x = 100; player.y = 300; 

        // Generazione Ostacoli
        let density = Math.min(25, 4 + level * 2); 
        
        for(let i=0; i<density; i++) {
            let type = "crate";
            let rand = Math.random();
            
            if(theme.includes("wood")) {
                type = rand>0.6 ? "table" : (rand>0.3 ? "wall_hedge" : "shelf");
            } else if (theme === "tech") {
                type = rand>0.6 ? "serverRack" : (rand>0.3 ? "gen" : "pipe");
            } else {
                type = rand>0.7 ? "rock" : "wall";
            }

            if (Math.random() < Math.min(0.5, level * 0.05)) type = (Math.random()>0.5) ? "acid" : "laser";

            let rx = 100 + Math.floor(Math.random() * 11) * 50; 
            let ry = 100 + Math.floor(Math.random() * 8) * 50;
            
            // Check zona sicura per non bloccare spawn e uscita
            if (Math.abs(rx - 750) < 100 && Math.abs(ry - 250) < 150) continue; // Zona uscita
            if (Math.abs(rx - 100) < 100 && Math.abs(ry - 300) < 100) continue; // Zona spawn

            let rw = 50; let rh = 50;
            if(type.startsWith("wall") || type==="acid") { if(Math.random()>0.5) rw=100; else rh=100; }
            addObj(rx, ry, rw, rh, type);
        }

        // Piazza Chiave (Garanzia di raggiungibilit√† base)
        let keyPlaced = false;
        while(!keyPlaced) {
            let kx = 200 + Math.random() * 400; let ky = 100 + Math.random() * 400;
            let safe = true;
            for(let o of currentRoom.objects) { if(checkRect(kx, ky, 40, 40, o) && o.solid) safe = false; }
            if(safe) {
                addObj(kx, ky, 50, 40, "chest", { contains: "key" });
                keyPlaced = true;
            }
        }

        // Oggetti Aiuto
        if(Math.random() < 0.2 || state.hp < 2) spawnItem("potion"); 
        if(level > 3 && !state.hasBoots && Math.random() < 0.3) spawnItem("boots");
        if(level > 5 && !state.hasFlashlight && Math.random() < 0.3) spawnItem("flashlight");
        if(level > 7 && !state.hasGoggles && Math.random() < 0.3) spawnItem("goggles");
    }

    function spawnItem(itemType) {
        let ix = 200 + Math.random() * 400; let iy = 150 + Math.random() * 300;
        addObj(ix, iy, 40, 40, itemType, { pickup: true });
    }

    function addObj(x, y, w, h, type, props = {}) {
        let obj = { x, y, w, h, type, solid: true, ...props };
        if(["rug", "flower", "acid", "laser", "cobweb", "pipe"].includes(type) || props.pickup) obj.solid = false;
        currentRoom.objects.push(obj);
    }

    function checkRect(x, y, w, h, obj) {
        return (x < obj.x + obj.w && x + w > obj.x && y < obj.y + obj.h && y + h > obj.y);
    }

    // --- GAMEPLAY LOOP ---
    function update() {
        if (!isPlaying) return;
        gameTime++;
        if(player.invulnerable > 0) player.invulnerable--;

        let nx = player.x, ny = player.y;
        if (keys.ArrowUp) ny -= player.speed; if (keys.ArrowDown) ny += player.speed;
        if (keys.ArrowLeft) { nx -= player.speed; player.facing = -1; } if (keys.ArrowRight) { nx += player.speed; player.facing = 1; }
        
        if (!checkCollision(nx, player.y)) player.x = nx;
        if (!checkCollision(player.x, ny)) player.y = ny;
        
        checkHazards();
        updateHUD();
    }

    function checkCollision(nx, ny) {
        if (nx < 0 || nx > 800 - player.w || ny < 0 || ny > 600 - player.h) return true;
        for (let obj of currentRoom.objects) {
            if (obj.pickedUp) continue; 
            if (obj.solid) {
                if (nx < obj.x + obj.w && nx + player.w > obj.x &&
                    ny < obj.y + obj.h && ny + player.h > obj.y) {
                    return true;
                }
            }
        }
        return false;
    }

    function checkHazards() {
        if(player.invulnerable > 0) return;
        let px = player.x + player.w/2; let py = player.y + player.h/2;
        let hit = false;
        for (let obj of currentRoom.objects) {
            if (obj.pickedUp) continue;
            if (obj.type === "acid" && !state.hasBoots) {
                if (px > obj.x && px < obj.x + obj.w && py > obj.y && py < obj.y + obj.h) { hit = true; }
            }
            if (obj.type === "laser") {
                if (px > obj.x && px < obj.x + obj.w && py > obj.y && py < obj.y + obj.h) { hit = true; }
            }
        }
        if(hit) takeDamage();
    }

    function takeDamage() {
        state.hp--;
        player.invulnerable = 60; 
        showDialog(translations[curLang].msg_ouch);
        ctx.fillStyle = "rgba(255,0,0,0.5)"; ctx.fillRect(0,0,800,600);
        player.x = 100; player.y = 300; 
        if(state.hp <= 0) gameOver();
    }

    function gameOver() {
        isPlaying = false;
        // TRADUZIONE STATISTICHE FINALI
        const t = translations[curLang];
        document.getElementById('finalStats').innerText = `${t.stat_lvl}: ${state.level} - ${t.stat_pts}: ${state.score}`;
        gameOverScreen.style.display = "flex";
    }

    function interact() {
        let cx = player.x + player.w/2; let cy = player.y + player.h/2;
        for (let obj of currentRoom.objects) {
            if (obj.pickedUp) continue;
            let ox = obj.x + obj.w/2; let oy = obj.y + obj.h/2;
            if (Math.hypot(cx - ox, cy - oy) < 80) { handleInteraction(obj); return; }
        }
    }

    function handleInteraction(obj) {
        const t = translations[curLang]; // Shortcut traduzione
        if(obj.pickup) {
            obj.pickedUp = true;
            if(obj.type === "potion") { state.hp = Math.min(3, state.hp+1); showDialog(t.msg_potion); }
            if(obj.type === "flashlight") { state.hasFlashlight = true; showDialog(t.msg_flash); }
            if(obj.type === "boots") { state.hasBoots = true; showDialog(t.msg_boots); }
            if(obj.type === "goggles") { state.hasGoggles = true; showDialog(t.msg_goggles); }
            addScore(50); return;
        }
        if(obj.type.includes("chest")) {
            if(obj.opened) return;
            obj.opened = true;
            if(obj.contains === "key") {
                state.hasKey = true;
                addScore(100);
                showDialog(t.msg_key);
            } else { addScore(20); showDialog(t.msg_gold); }
            return;
        }
        if(obj.type === "door") {
            if(state.hasKey) {
                showDialog(t.msg_win);
                addScore(200);
                state.level++;
                setTimeout(() => generateLevel(state.level), 1000);
            } else { showDialog(t.msg_lock); }
        }
    }

    function addScore(points) { state.score += points; }
    
    function updateHUD() {
        let hearts = "‚ù§".repeat(state.hp) + "‚ô°".repeat(3-state.hp);
        lifeText.innerText = hearts;
        // TRADUZIONE HUD LIVE
        levelText.innerText = translations[curLang].hud_lvl + " " + state.level;
        scoreText.innerText = translations[curLang].hud_pts + ": " + state.score;
        
        // Icona chiave nell'hud
        if(state.hasKey) { ctx.font="30px Arial"; ctx.fillText("üîë", 750, 50); }
    }

    function showDialog(text) {
        dialogBox.innerText = text; dialogBox.style.display='block';
        if(dialogTimer) clearTimeout(dialogTimer);
        dialogTimer = setTimeout(()=>dialogBox.style.display='none', 2000);
    }

    // --- DISEGNO OGGETTI ---
    function draw() {
        drawFloor(currentRoom.bgType);
        currentRoom.objects.forEach(obj => { if(!obj.solid && obj.type !== "door") drawObject(obj); }); // Layer sotto
        
        if (currentRoom.darkness && !state.hasFlashlight) {
            ctx.fillStyle = "rgba(0,0,0,0.96)"; ctx.fillRect(0,0,800,600);
            let grad = ctx.createRadialGradient(player.x+14, player.y+14, 20, player.x+14, player.y+14, 130);
            grad.addColorStop(0, "rgba(0,0,0,0)"); grad.addColorStop(1, "rgba(0,0,0,1)");
            ctx.globalCompositeOperation = 'destination-out';
            ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(player.x+14, player.y+14, 130, 0, Math.PI*2); ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
        }

        let renderList = currentRoom.objects.filter(obj => obj.solid || obj.type === "door");
        renderList.push({ ...player, isPlayer: true });
        renderList.sort((a,b) => (a.y + a.h) - (b.y + b.h));

        renderList.forEach(obj => {
            if (obj.pickedUp) return;
            if (obj.isPlayer) drawPlayer();
            else drawObject(obj); 
        });

        if (state.hasGoggles) {
            ctx.strokeStyle = "rgba(0, 255, 0, 0.3)"; ctx.lineWidth=1;
            for(let o of currentRoom.objects) { if(o.type==="laser") ctx.strokeRect(o.x, o.y, o.w, o.h); }
        }
        updateHUD();
    }

    function drawFloor(type) {
        let sz = 40; let c1="#5d4037", c2="#4e342e";
        if (type === "stone") { c1="#424242"; c2="#616161"; sz=50; }
        if (type === "tile") { c1="#ecf0f1"; c2="#bdc3c7"; sz=50; }
        if (type === "tech") { c1="#263238"; c2="#37474f"; sz=50; }
        for(let y=0; y<600; y+=sz) for(let x=0; x<800; x+=sz) {
            ctx.fillStyle = ((x+y)%(sz*2)===0) ? c1 : c2; ctx.fillRect(x, y, sz, sz);
            if(type==="wood" || type==="wood_old") { ctx.fillStyle="rgba(0,0,0,0.1)"; ctx.fillRect(x,y,sz,2); }
        }
    }

    function drawObject(obj) {
        ctx.save();
        // Muri 2.5D
        if (obj.type === "wall" || obj.type === "rock" || obj.type === "wall_hedge") {
            let isHedge = obj.type === "wall_hedge";
            let isRock = obj.type === "rock";
            let face = isHedge ? "#1b5e20" : (isRock ? "#546e7a" : "#616161"); 
            let top = isHedge ? "#2e7d32" : (isRock ? "#78909c" : "#757575");
            ctx.fillStyle = face; ctx.fillRect(obj.x, obj.y, obj.w, obj.h); 
            ctx.fillStyle = top; ctx.fillRect(obj.x, obj.y, obj.w, 15); 
            ctx.strokeStyle = "rgba(0,0,0,0.3)"; ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
            if(isRock) { ctx.fillStyle="rgba(0,0,0,0.2)"; ctx.fillRect(obj.x+10, obj.y+20, 10, 10); }
            ctx.restore(); return;
        }

        // Ombra
        if(!["acid", "rug", "flower"].includes(obj.type)) {
            ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.beginPath(); ctx.ellipse(obj.x + obj.w/2, obj.y + obj.h - 2, obj.w/2, 6, 0, 0, Math.PI*2); ctx.fill();
        }

        // Oggetti specifici
        if (obj.type.includes("chest")) {
            let col = obj.opened ? "#5d4037" : (obj.type==="goldChest"?"#f1c40f":"#8d6e63");
            ctx.fillStyle = col; ctx.fillRect(obj.x, obj.y+10, obj.w, obj.h-10); 
            if(!obj.opened) { ctx.fillStyle = col; ctx.filter="brightness(1.2)"; ctx.fillRect(obj.x, obj.y, obj.w, 15); ctx.fillStyle="#000"; ctx.fillRect(obj.x+obj.w/2-3, obj.y+10, 6, 8); } 
            else { ctx.fillStyle = "#000"; ctx.fillRect(obj.x+5, obj.y+5, obj.w-10, 10); }
            ctx.filter="none"; ctx.strokeStyle="#000"; ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
        }
        else if(obj.type === "door") {
            ctx.fillStyle = state.hasKey ? "#27ae60" : "#c0392b"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            ctx.strokeStyle="#fff"; ctx.lineWidth=3; ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
            ctx.fillStyle="#fff"; ctx.font="10px Arial"; ctx.fillText(state.hasKey?"EXIT":"LOCK", obj.x+5, obj.y+obj.h/2);
        }
        else if (obj.type === "crate") {
            ctx.fillStyle = "#8d6e63"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            ctx.strokeStyle = "#5d4037"; ctx.lineWidth=2; ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
            ctx.beginPath(); ctx.moveTo(obj.x, obj.y); ctx.lineTo(obj.x+obj.w, obj.y+obj.h); ctx.stroke();
        }
        else if (obj.type === "table") {
            ctx.fillStyle = "#5d4037"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            ctx.fillStyle = "#ecf0f1"; ctx.fillRect(obj.x, obj.y, obj.w, 20); 
        }
        else if (obj.type === "shelf") {
            ctx.fillStyle = "#5d4037"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            for(let i=15; i<obj.h; i+=25) {
                ctx.fillStyle = "#3e2723"; ctx.fillRect(obj.x, obj.y+i, obj.w, 4);
                for(let k=5; k<obj.w-10; k+=10) { ctx.fillStyle = `hsl(${(k*20)%360}, 60%, 50%)`; ctx.fillRect(obj.x+k, obj.y+i-15, 6, 15); }
            }
        }
        else if (obj.type === "gen") {
            ctx.fillStyle = "#34495e"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h); ctx.fillStyle = "#f1c40f"; ctx.fillRect(obj.x+10, obj.y+20, 10, obj.h-40);
        }
        else if (obj.type === "serverRack") {
            ctx.fillStyle = "#2d3436"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            ctx.fillStyle = "#00b894"; for(let i=10; i<obj.h; i+=15) if(Math.random()>0.5) ctx.fillRect(obj.x+5, obj.y+i, 4, 4);
        }
        else if (obj.type === "pipe") {
            ctx.fillStyle = "#95a5a6"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            ctx.fillStyle = "#bdc3c7"; ctx.fillRect(obj.x+5, obj.y, 5, obj.h); 
        }
        else if (obj.type === "acid") {
            ctx.fillStyle = "rgba(46, 204, 113, 0.8)"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
            if(gameTime%20<10) { ctx.fillStyle="#fff"; ctx.fillRect(obj.x+Math.random()*obj.w, obj.y+Math.random()*obj.h, 4, 4); }
        }
        else if (obj.pickup) {
            ctx.fillStyle = "yellow"; ctx.beginPath(); ctx.arc(obj.x+obj.w/2, obj.y+obj.h/2, 10, 0, Math.PI*2); ctx.fill();
            if(obj.type==="potion") { ctx.fillStyle="red"; ctx.fillText("‚ô•", obj.x+10, obj.y+25); }
            else if(obj.type==="boots") ctx.fillStyle="orange"; 
            else if(obj.type==="flashlight") ctx.fillStyle="white";
            ctx.fill();
        }
        else {
            ctx.fillStyle = "#7f8c8d"; ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
        }
        ctx.restore();
    }

    function drawPlayer() {
        if(player.invulnerable > 0 && Math.floor(gameTime/4)%2===0) return; 
        ctx.font = "32px serif"; ctx.textAlign = "center"; ctx.save();
        ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.beginPath(); ctx.ellipse(player.x+14, player.y+26, 10, 4, 0, 0, Math.PI*2); ctx.fill();
        let breathe = Math.sin(gameTime * 0.1) * 2;
        if (player.facing === -1) { ctx.translate(player.x+28, player.y + breathe); ctx.scale(-1, 1); ctx.fillText(player.sprite, 14, 28); } 
        else { ctx.fillText(player.sprite, player.x+14, player.y+28 + breathe); }
        ctx.restore();
    }

    // --- SETUP ---
    window.addEventListener('keydown', e => { keys[e.code] = true; if(e.code==='Space' && isPlaying) interact(); });
    window.addEventListener('keyup', e => { keys[e.code] = false; });

    function bindTouch(id, code) {
        const btn = document.getElementById(id); if(!btn) return;
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); keys[code] = true; if(code==='Space' && isPlaying) interact(); }, {passive: false});
        btn.addEventListener('touchend', (e) => { e.preventDefault(); keys[code] = false; }, {passive: false});
        btn.addEventListener('mousedown', (e) => { keys[code] = true; if(code==='Space' && isPlaying) interact(); });
        btn.addEventListener('mouseup', (e) => { keys[code] = false; });
    }
    bindTouch('btnUp', 'ArrowUp'); bindTouch('btnDown', 'ArrowDown'); bindTouch('btnLeft', 'ArrowLeft'); bindTouch('btnRight', 'ArrowRight'); bindTouch('btnAction', 'Space');

    function loop() { update(); draw(); requestAnimationFrame(loop); }
    function selectChar(s) { player.sprite = s; document.getElementById('screenSelection').classList.add('hidden'); document.getElementById('screenName').classList.remove('hidden'); }
    function startGame() { 
        player.name = document.getElementById('playerNameInput').value || "Eroe"; 
        document.getElementById('screenName').classList.add('hidden'); 
        isPlaying = true; 
        generateLevel(1); 
        loop(); 
    }
    function restartGame() {
        gameOverScreen.style.display = "none";
        state.level = 1; state.hp = 3; state.score = 0; state.hasBoots = false; state.hasFlashlight = false; state.hasGoggles = false;
        startGame();
    }
</script>
</body>
</html>
