<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Space Shooter - Enemy Update</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    
    <style>
        /* --- BASE (Comune) --- */
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            background-color: #121212; 
            color: #eee; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            min-height: 100vh;
            height: 100dvh; 
            touch-action: none; 
            user-select: none;
            overflow: hidden;
        }

        /* --- ISTRUZIONI PC --- */
        .pc-instructions {
            display: none;
            text-align: center;
            margin-bottom: 20px;
            color: #888;
        }
        .pc-key {
            display: inline-block; padding: 5px 10px; border: 1px solid #555; border-radius: 5px; background: #222; margin: 0 5px; font-weight: bold; color: #00979D;
        }

        /* --- CONTENITORE PRINCIPALE --- */
        .game-case {
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            transition: all 0.5s ease;
        }

        /* --- LO SCHERMO --- */
        .screen-container {
            background-color: #000;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .screen-glass {
            position: relative;
            flex-grow: 1;
            border: 2px solid #333;
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; }

        #scoreBoard {
            position: absolute; top: 10px; left: 10px;
            color: #00979D; font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.5rem; z-index: 5;
            text-shadow: 0 0 5px rgba(0, 151, 157, 0.8);
        }

        /* --- CONTROLLI MOBILE --- */
        .mobile-controls { display: none; }

        /* =========================================
           STILE MOBILE (GAME BOY) - Schermi < 800px
           ========================================= */
        @media (max-width: 800px) {
            .game-case {
                background-color: #c0c0c0;
                width: 100%; 
                height: 100dvh;
                border-radius: 0; 
                padding: 10px;
                box-sizing: border-box;
                justify-content: space-between;
            }

            .screen-container {
                background-color: #777; padding: 10px 10px 0 10px; border-radius: 10px 10px 40px 10px;
                flex-grow: 1; 
                margin-bottom: 10px; 
                box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5);
                min-height: 0;
            }

            .screen-glass { background: #0d0d1a; border: 2px solid #444; }

            .mobile-controls {
                display: flex; 
                height: 160px;
                justify-content: space-between; 
                align-items: center; 
                padding: 0 5px; 
                position: relative;
                flex-shrink: 0;
            }

            .d-pad { width: 90px; height: 90px; position: relative; }
            .d-key { background: #333; position: absolute; border-radius: 4px; box-shadow: 2px 2px 0 #000; width: 30px; height: 30px; }
            .d-key:active, .d-key.pressed { background: #555; transform: translate(1px,1px); box-shadow: none;}
            
            .d-up { top: 0; left: 30px; }
            .d-down { bottom: 0; left: 30px; }
            .d-left { top: 30px; left: 0; }
            .d-right { top: 30px; right: 0; }

            .btn-action {
                width: 60px; height: 60px;
                background: #ff4444; border-radius: 50%;
                box-shadow: 2px 2px 0 #800000; display: flex; align-items: center; justify-content: center;
                font-weight: bold; font-size: 1.3rem; color: rgba(0,0,0,0.3);
            }
            .btn-action:active, .btn-action.pressed { transform: translate(1px,1px); box-shadow: none; }

            .btn-reset {
                position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%) rotate(-20deg);
                width: 50px; height: 15px; background: #666; border-radius: 10px; border: none;
            }
        }

        /* =========================================
           STILE PC (CABINATO) - Schermi > 800px
           ========================================= */
        @media (min-width: 801px) {
            .pc-instructions { display: block; }
            .game-case {
                width: 800px; height: 600px; background-color: #222; border: 10px solid #444; border-radius: 20px; padding: 20px; position: relative;
            }
            .game-case::after {
                content: ''; position: absolute; top: -15px; left: -15px; right: -15px; bottom: -15px;
                border: 5px solid #00979D; border-radius: 30px; z-index: -1; box-shadow: 0 0 30px #00979D;
            }
            .screen-container {
                width: 100%; height: 100%; background: #000; border-radius: 10px; border: 4px solid #111;
            }
            .screen-glass {
                border: none;
                background: repeating-linear-gradient(0deg, rgba(0,0,0,0.15), rgba(0,0,0,0.15) 1px, transparent 1px, transparent 2px);
                background-size: 100% 2px;
            }
        }

        /* Overlay Game Over */
        #gameOverOverlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95); border: 2px solid #00979D; color: white; padding: 30px;
            text-align: center; display: none; z-index: 10; min-width: 250px; border-radius: 10px;
        }
        .btn-retry {
            margin-top: 15px; padding: 10px 20px; background: #00979D; color: white; border: none; font-size: 1rem; cursor: pointer; border-radius: 5px;
        }
        .home-link {
            position: fixed; top: 20px; right: 20px; color: #666; text-decoration: none; font-size: 0.9rem; z-index: 100;
        }
        .home-link:hover { color: #fff; }
    </style>
</head>
<body>

<a href="index.html" class="home-link">‚úñ ESCI</a>

<div class="pc-instructions">
    COMANDI: <span class="pc-key">‚Üê</span> <span class="pc-key">‚Üë</span> <span class="pc-key">‚Üì</span> <span class="pc-key">‚Üí</span> MUOVI &nbsp;&nbsp; <span class="pc-key">SPACE</span> SPARA
</div>

<div class="game-case">
    <div class="screen-container">
        <div class="screen-glass">
            <div id="scoreBoard">SCORE: 0000</div>
            <canvas id="gameCanvas"></canvas>
            <div id="gameOverOverlay">
                <h2 style="color: #ff4444; margin: 0 0 10px 0;">GAME OVER</h2>
                <p id="finalScore" style="font-size: 1.2rem;">Punti: 0</p>
                <button class="btn-retry" onclick="resetGame()">RIPROVA</button>
            </div>
        </div>
    </div>

    <div class="mobile-controls">
        <div class="d-pad">
            <div class="d-key d-up" id="btnUp"></div>
            <div class="d-key d-left" id="btnLeft"></div>
            <div class="d-key d-right" id="btnRight"></div>
            <div class="d-key d-down" id="btnDown"></div>
        </div>
        <button class="btn-reset" id="btnResetMobile"></button>
        <div class="btn-action" id="btnFire">A</div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('scoreBoard');
    const gameOverOverlay = document.getElementById('gameOverOverlay');
    const finalScoreText = document.getElementById('finalScore');

    function resizeCanvas() {
        const container = document.querySelector('.screen-glass');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    
    let score = 0; let gameOver = false; let frameCount = 0;
    const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, Space: false };

    function setupTouch(elemId, keyName) {
        const el = document.getElementById(elemId);
        if(!el) return;
        const press = (e) => { e.preventDefault(); keys[keyName] = true; el.classList.add('pressed'); };
        const release = (e) => { e.preventDefault(); keys[keyName] = false; el.classList.remove('pressed'); };
        el.addEventListener('touchstart', press); el.addEventListener('touchend', release);
        el.addEventListener('mousedown', press); el.addEventListener('mouseup', release);
    }

    setupTouch('btnUp', 'ArrowUp'); setupTouch('btnDown', 'ArrowDown');
    setupTouch('btnLeft', 'ArrowLeft'); setupTouch('btnRight', 'ArrowRight');
    setupTouch('btnFire', 'Space');
    document.getElementById('btnResetMobile').addEventListener('click', resetGame);

    window.addEventListener('keydown', e => {
        if(e.code === 'Space') keys.Space = true;
        if(e.key.startsWith('Arrow')) keys[e.key] = true;
    });
    window.addEventListener('keyup', e => {
        if(e.code === 'Space') keys.Space = false;
        if(e.key.startsWith('Arrow')) keys[e.key] = false;
    });

    const player = { x: 100, y: 300, width: 30, height: 30, speed: 6 };
    let bullets = []; 
    let enemyBullets = []; // Nuovi proiettili nemici
    let enemies = []; 
    let stars = [];
    
    // Configurazione Nemici
    const enemyConfig = {
        'invader': { score: 10, color: '#32CD32', shootChance: 0 },
        'crystal': { score: 20, color: '#00BFFF', shootChance: 0 },
        'hunter':  { score: 40, color: '#FF4500', shootChance: 0.015 }, // Spara occasionalmente
        'saucer':  { score: 80, color: '#9370DB', shootChance: 0.025 }  // Spara spesso
    };
    const enemyTypes = Object.keys(enemyConfig);

    function drawPlayer(x, y, w, h) {
        ctx.fillStyle = '#00e5ff'; ctx.beginPath(); ctx.moveTo(x+w/2, y); ctx.lineTo(x, y+h); ctx.lineTo(x+w/2, y+h-8); ctx.lineTo(x+w, y+h); ctx.fill();
        // Dettaglio motore
        ctx.fillStyle = '#ff9900'; ctx.fillRect(x+w/2-2, y+h-4, 4, 6);
    }

    // NUOVO SISTEMA DI DISEGNO NEMICI
    function drawEnemy(enemy) {
        const { x, y, width: w, height: h, color, type } = enemy;
        ctx.fillStyle = color;
        
        ctx.save();
        ctx.translate(x, y);

        if(type === 'invader') {
            // Forma classica granchio
            ctx.fillRect(w*0.2, h*0.2, w*0.6, h*0.6); // Corpo
            ctx.fillRect(0, 0, w*0.2, h*0.4); // Antenne
            ctx.fillRect(w*0.8, 0, w*0.2, h*0.4);
            ctx.fillRect(0, h*0.6, w*0.2, h*0.4); // Zampe
            ctx.fillRect(w*0.8, h*0.6, w*0.2, h*0.4);
        }
        else if(type === 'hunter') {
            // Forma a freccia aggressiva
            ctx.beginPath();
            ctx.moveTo(w/2, h);      // Punta in basso (muso)
            ctx.lineTo(w, 0);        // Ala dx
            ctx.lineTo(w/2, h*0.3);  // Incavo
            ctx.lineTo(0, 0);        // Ala sx
            ctx.closePath();
            ctx.fill();
        }
        else if(type === 'saucer') {
            // Forma disco volante
            ctx.beginPath();
            ctx.ellipse(w/2, h/2, w/2, h/4, 0, 0, Math.PI*2); // Disco
            ctx.fill();
            ctx.fillStyle = "#fff"; // Cupola
            ctx.beginPath();
            ctx.arc(w/2, h/2-5, w/4, Math.PI, 0);
            ctx.fill();
            // Luci
            ctx.fillStyle = "yellow";
            ctx.fillRect(w*0.2, h*0.6, 4, 4);
            ctx.fillRect(w*0.5, h*0.7, 4, 4);
            ctx.fillRect(w*0.8, h*0.6, 4, 4);
        }
        else { // Crystal
            // Rombo
            ctx.beginPath();
            ctx.moveTo(w/2, 0);
            ctx.lineTo(w, h/2);
            ctx.lineTo(w/2, h);
            ctx.lineTo(0, h/2);
            ctx.closePath();
            ctx.fill();
            // Core
            ctx.fillStyle = "white";
            ctx.fillRect(w/2-3, h/2-3, 6, 6);
        }
        ctx.restore();
    }

    function spawnEnemy() {
        let spawnRate = 60; if (score > 1000) spawnRate = 40;
        if (frameCount % spawnRate === 0) {
            const type = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            const config = enemyConfig[type];
            enemies.push({ 
                x: Math.random()*(canvas.width-30), 
                y: -30, 
                width: 30, height: 30, 
                type: type, 
                color: config.color, 
                scoreValue: config.score,
                shootChance: config.shootChance,
                speed: 2 + Math.random()*2 
            });
        }
    }

    function checkCollision(r1, r2) {
        return (r1.x < r2.x + r2.width &&
                r1.x + r1.width > r2.x &&
                r1.y < r2.y + r2.height &&
                r1.y + r1.height > r2.y);
    }

    function triggerGameOver() {
        gameOver = true;
        gameOverOverlay.style.display = 'block';
        finalScoreText.innerText = "Punti: " + score;
    }

    function update() {
        if (gameOver) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Sfondo stelle
        if(stars.length < 50) stars.push({ x: Math.random()*canvas.width, y: 0, size: Math.random()*2, speed: Math.random()*4+1 });
        stars.forEach((s, i) => { ctx.fillStyle = "white"; ctx.fillRect(s.x, s.y, s.size, s.size); s.y += s.speed; if(s.y > canvas.height) stars.splice(i, 1); });

        // Movimento Player
        if (keys.ArrowUp && player.y > 0) player.y -= player.speed;
        if (keys.ArrowDown && player.y < canvas.height - player.height) player.y += player.speed;
        if (keys.ArrowLeft && player.x > 0) player.x -= player.speed;
        if (keys.ArrowRight && player.x < canvas.width - player.width) player.x += player.speed;
        
        // Sparo Player
        if (keys.Space && frameCount % 10 === 0) bullets.push({ x: player.x+13, y: player.y, width: 4, height: 10, color: '#FFD700', speed: 10 });

        drawPlayer(player.x, player.y, player.width, player.height);

        // Aggiorna Proiettili Player
        for (let i = bullets.length - 1; i >= 0; i--) {
            let b = bullets[i]; b.y -= b.speed; ctx.fillStyle = b.color; ctx.fillRect(b.x, b.y, b.width, b.height); 
            if (b.y < 0) bullets.splice(i, 1);
        }

        // Aggiorna Proiettili Nemici
        for (let i = enemyBullets.length - 1; i >= 0; i--) {
            let eb = enemyBullets[i];
            eb.y += eb.speed;
            ctx.fillStyle = "#FF0000"; // Rosso pericolo
            ctx.fillRect(eb.x, eb.y, eb.width, eb.height);

            // Collisione Proiettile Nemico -> Player
            if (checkCollision(eb, player)) {
                triggerGameOver();
            }

            if (eb.y > canvas.height) enemyBullets.splice(i, 1);
        }

        spawnEnemy();
        
        // Loop Nemici
        for (let i = enemies.length - 1; i >= 0; i--) {
            let e = enemies[i]; e.y += e.speed; 
            drawEnemy(e);

            // Nemico spara?
            if (e.shootChance > 0 && Math.random() < e.shootChance) {
                enemyBullets.push({
                    x: e.x + e.width/2 - 2,
                    y: e.y + e.height,
                    width: 5, height: 10,
                    speed: 5
                });
            }

            // Collisione Nemico -> Player
            let pad = 4;
            let playerHitbox = {x: player.x+pad, y: player.y+pad, width: player.width-pad*2, height: player.height-pad*2};
            if (checkCollision(playerHitbox, e)) {
                triggerGameOver();
            }

            if (e.y > canvas.height) { enemies.splice(i, 1); continue; }
            
            // Collisione Proiettile Player -> Nemico
            for (let j = bullets.length - 1; j >= 0; j--) {
                let b = bullets[j];
                if (checkCollision(b, e)) {
                    // Punteggio dinamico in base al tipo
                    score += e.scoreValue; 
                    scoreElement.innerText = "SCORE: " + score.toString().padStart(4, '0');
                    enemies.splice(i, 1); bullets.splice(j, 1); break;
                }
            }
        }
        frameCount++; requestAnimationFrame(update);
    }

    function resetGame() {
        gameOver = false; score = 0; scoreElement.innerText = "SCORE: 0000";
        enemies = []; bullets = []; enemyBullets = []; // Pulisci tutto
        player.x = canvas.width/2-15; player.y = canvas.height-50;
        gameOverOverlay.style.display = 'none'; update();
    }

    resizeCanvas(); setTimeout(resizeCanvas, 100); resetGame();
</script>
</body>
</html>
