<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Mario 8-Bit</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * { box-sizing: border-box; touch-action: none; user-select: none; }

        body { 
            margin: 0; padding: 0; 
            background-color: #101010; 
            font-family: 'Press Start 2P', cursive;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden; color: white;
        }

        /* --- STILE PC --- */
        canvas { 
            background-color: #5c94fc; /* BLU MARIO */
            width: 800px; height: 600px;
            max-width: 100%; max-height: 100%;
            image-rendering: pixelated; /* PIXEL NITIDI */
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
            border: 4px solid #fff;
        }

        #hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 800px; max-width: 90%;
            display: flex; justify-content: space-between;
            text-shadow: 2px 2px 0 #000; font-size: 16px; color: #fff; pointer-events: none;
            z-index: 10;
        }

        /* --- STILE MOBILE (Game Boy) --- */
        .mobile-controls { display: none; }

        @media (max-width: 768px) {
            #hud { width: 90%; font-size: 10px; top: 10px; }
            body { background-color: #ddd; justify-content: flex-start; }
            
            .game-boy-case {
                width: 100%; height: 100dvh;
                display: flex; flex-direction: column;
                background: #f2f2f2;
            }

            .screen-wrapper {
                background: #777;
                padding: 15px 15px 0 15px;
                border-radius: 0 0 30px 30px;
                box-shadow: inset 0 -5px 10px rgba(0,0,0,0.2);
            }

            canvas {
                width: 100%; height: auto; aspect-ratio: 4/3;
                border: 4px solid #222; background-color: #5c94fc;
                box-shadow: none;
            }

            .mobile-controls {
                display: flex; flex: 1; justify-content: space-between; align-items: center; padding: 20px;
            }

            .d-pad { position: relative; width: 120px; height: 120px; }
            .btn-dir { position: absolute; background: #333; width: 40px; height: 40px; border-radius: 4px; box-shadow: 0 4px 0 #111; }
            .btn-dir:active { transform: translateY(4px); box-shadow: none; }
            #up { top:0; left:40px; } #down { bottom:0; left:40px; } #left { top:40px; left:0; } #right { top:40px; right:0; }

            .action-area { display: flex; gap: 15px; transform: rotate(-15deg); margin-right: 20px; }
            .btn-act { width: 55px; height: 55px; border-radius: 50%; background: #d00; border: none; box-shadow: 2px 4px 0 #800; color: rgba(0,0,0,0.3); font-weight: bold; font-size: 18px; }
            .btn-act:active { transform: translateY(4px); box-shadow: none; }
        }
    </style>
</head>
<body>

<div id="hud">
    <div>MARIO<br>000000</div>
    <div>COINS<br>ðŸŸ¡ <span id="coin-count">0</span></div>
    <div>WORLD<br>1-1</div>
    <div>TIME<br>âˆž</div>
</div>

<div class="game-boy-case">
    <div class="screen-wrapper">
        <canvas id="gameCanvas" width="320" height="240"></canvas>
    </div>
    <div class="mobile-controls">
        <div class="d-pad">
            <div class="btn-dir" id="up"></div>
            <div class="btn-dir" id="down"></div>
            <div class="btn-dir" id="left"></div>
            <div class="btn-dir" id="right"></div>
        </div>
        <div class="action-area">
            <button class="btn-act" id="btnB">B</button>
            <button class="btn-act" id="btnA">A</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- GENERATORE DI GRAFICA PIXEL ART ---
    // Invece di caricare file, creiamo le immagini via codice!
    const sprites = {};
    const TILE = 16;

    function createSprite(color, type) {
        const c = document.createElement('canvas');
        c.width = TILE; c.height = TILE;
        const x = c.getContext('2d');
        
        if (type === 'ground') {
            x.fillStyle = "#C84C0C"; // Ruggine
            x.fillRect(0, 0, 16, 16);
            x.fillStyle = "#000"; // Dettagli neri
            x.fillRect(0, 0, 16, 2); // Linea sopra
            x.fillRect(8, 2, 2, 6); // Dettaglio mattone
            x.fillRect(0, 8, 2, 6);
        } else if (type === 'brick') {
            x.fillStyle = "#B83800"; // Rosso mattone
            x.fillRect(0, 0, 16, 16);
            x.fillStyle = "#000"; 
            x.fillRect(0, 0, 16, 1); x.fillRect(0, 8, 16, 1); // Linee orizzontali
            x.fillRect(8, 0, 1, 8); x.fillRect(0, 8, 1, 8); // Linee verticali
        } else if (type === 'box') {
            x.fillStyle = "#F89800"; // Oro
            x.fillRect(0, 0, 16, 16);
            x.fillStyle = "#000";
            x.fillRect(0,0,16,1); x.fillRect(0,0,1,16); x.fillRect(15,0,1,16); x.fillRect(0,15,16,1);
            x.fillRect(2,2,1,1); x.fillRect(13,2,1,1); x.fillRect(2,13,1,1); x.fillRect(13,13,1,1); // Bulloni
            x.fillStyle = "#884000";
            x.font = "bold 12px monospace";
            x.fillText("?", 4, 12);
        } else if (type === 'pipe_tl') { x.fillStyle = "#00A800"; x.fillRect(0,0,16,16); x.lineWidth=2; x.strokeRect(0,0,16,16); }
        else if (type === 'pipe_tr') { x.fillStyle = "#00A800"; x.fillRect(0,0,16,16); x.lineWidth=2; x.strokeRect(0,0,16,16); }
        else if (type === 'pipe_bl') { x.fillStyle = "#00A800"; x.fillRect(2,0,14,16); x.lineWidth=2; x.strokeRect(2,0,14,16); }
        else if (type === 'pipe_br') { x.fillStyle = "#00A800"; x.fillRect(0,0,14,16); x.lineWidth=2; x.strokeRect(0,0,14,16); }
        else if (type === 'mario') {
            x.fillStyle = "#F00"; // Vestito Rosso
            x.fillRect(4, 8, 8, 8); 
            x.fillStyle = "#884000"; // Faccia/Scarpe
            x.fillRect(4, 2, 9, 6); x.fillRect(2, 12, 4, 4); x.fillRect(11, 12, 4, 4);
        } else if (type === 'goomba') {
            x.fillStyle = "#884000"; // Marrone fungo
            x.beginPath(); x.arc(8, 8, 7, 0, Math.PI*2); x.fill();
            x.fillStyle = "black"; x.fillRect(4,12,3,4); x.fillRect(10,12,3,4); // Piedi
        } else if (type === 'cloud') {
            x.fillStyle = "#FFF"; x.beginPath(); x.arc(8,8,8,0,Math.PI*2); x.fill();
        } else if (type === 'bush') {
            x.fillStyle = "#00E000"; x.beginPath(); x.arc(8,8,8,0,Math.PI*2); x.fill();
        }
        
        return c;
    }

    // Creiamo gli asset in memoria
    sprites.ground = createSprite(null, 'ground');
    sprites.brick = createSprite(null, 'brick');
    sprites.box = createSprite(null, 'box');
    sprites.pipe_tl = createSprite(null, 'pipe_tl');
    sprites.pipe_tr = createSprite(null, 'pipe_tr');
    sprites.pipe_bl = createSprite(null, 'pipe_bl');
    sprites.pipe_br = createSprite(null, 'pipe_br');
    sprites.mario = createSprite(null, 'mario');
    sprites.enemy = createSprite(null, 'goomba');
    sprites.cloud = createSprite(null, 'cloud');
    sprites.bush = createSprite(null, 'bush');

    // --- GAME ENGINE ---
    let player = { x: 50, y: 100, w: 14, h: 14, vx: 0, vy: 0, grounded: false, facing: 1, coins: 0 };
    let cameraX = 0;
    let keys = { left: false, right: false, up: false, run: false };
    
    // Mappa generata proceduralmente
    let map = [];
    let decor = []; // Nuvole e cespugli

    function initMap() {
        // Genera 200 colonne
        for(let x=0; x<200; x++) {
            let col = new Array(15).fill(0);
            
            // Pavimento (ultime 2 righe)
            col[13] = 1; col[14] = 1; 

            // Buchi nel pavimento
            if(x > 69 && x < 72) { col[13] = 0; col[14] = 0; }

            // Blocchi e Tubi
            if(x > 10 && x < 200) {
                let r = Math.random();
                if(r > 0.92 && col[13] === 1) col[9] = (Math.random()>0.5 ? 2 : 3); // Box o Mattone
                
                // Tubi (Altezza variabile)
                if(x % 40 === 0 && x > 20) {
                    col[12] = 4; col[11] = 4; // Tubo base
                    col[10] = 5; // Tubo cima
                }

                // Nemici
                if(x > 20 && r > 0.98 && col[13] === 1) {
                    col[12] = 8; // Goomba a terra
                }
            }
            map.push(col);

            // Genera Decorazioni Sfondo (Nuvole/Cespugli)
            if(Math.random() > 0.90) decor.push({x: x*TILE, y: (Math.random()*100)+20, type: 'cloud'});
            if(Math.random() > 0.92) decor.push({x: x*TILE, y: 12*TILE, type: 'bush'});
        }
        // Muri inizio/fine
        map[0][12] = 3; map[199][12] = 3; 
    }
    initMap();

    // Loop Fisica
    function update() {
        // Input
        if(keys.left) { player.vx -= 0.5; player.facing = -1; }
        if(keys.right) { player.vx += 0.5; player.facing = 1; }
        
        // Attrito
        player.vx *= 0.85;
        let maxSpeed = keys.run ? 3.5 : 2.0;
        if(player.vx > maxSpeed) player.vx = maxSpeed;
        if(player.vx < -maxSpeed) player.vx = -maxSpeed;

        // GravitÃ 
        player.vy += 0.25;

        // Salto
        if(keys.up && player.grounded) {
            player.vy = -6.5;
            player.grounded = false;
        }

        // Applicazione X
        player.x += player.vx;
        checkCollision(true);

        // Applicazione Y
        player.y += player.vy;
        player.grounded = false;
        checkCollision(false);

        // Morte caduta
        if(player.y > 250) {
            player.x = 50; player.y = 100; player.vy = 0; // Respawn
        }

        // Camera Follow
        let targetCam = player.x - 120;
        if(targetCam < 0) targetCam = 0;
        cameraX += (targetCam - cameraX) * 0.1;
    }

    function checkCollision(isX) {
        let startX = Math.floor(player.x / TILE);
        let endX = Math.floor((player.x + player.w) / TILE);
        let startY = Math.floor(player.y / TILE);
        let endY = Math.floor((player.y + player.h) / TILE);

        for(let y = startY; y <= endY; y++) {
            for(let x = startX; x <= endX; x++) {
                if(x < 0 || x >= 200 || y < 0 || y >= 15) continue;
                
                let tile = map[x][y];
                // 1=Terra, 2=Box, 3=Mattone, 4=TuboBase, 5=TuboAlto
                if(tile >= 1 && tile <= 7) { 
                    if(isX) {
                        if(player.vx > 0) player.x = x * TILE - player.w - 0.1;
                        else if(player.vx < 0) player.x = (x + 1) * TILE + 0.1;
                        player.vx = 0;
                    } else {
                        if(player.vy > 0) {
                            player.y = y * TILE - player.h - 0.1;
                            player.vy = 0;
                            player.grounded = true;
                        } else if(player.vy < 0) {
                            player.y = (y + 1) * TILE + 0.1;
                            player.vy = 0;
                            // Colpisci box
                            if(tile === 2) {
                                map[x][y] = 3; // Diventa mattone
                                player.coins++;
                                document.getElementById('coin-count').innerText = player.coins;
                            }
                        }
                    }
                }
            }
        }
    }

    function draw() {
        // 1. Cielo Azzurro
        ctx.fillStyle = "#5c94fc";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(-Math.floor(cameraX), 0);

        // 2. Disegna Sfondo (Nuvole/Cespugli)
        decor.forEach(d => {
            if(d.x > cameraX - 50 && d.x < cameraX + 350) {
                if(d.type === 'cloud') {
                    ctx.drawImage(sprites.cloud, d.x, d.y);
                    ctx.drawImage(sprites.cloud, d.x+10, d.y);
                    ctx.drawImage(sprites.cloud, d.x+20, d.y);
                }
                if(d.type === 'bush') {
                    ctx.drawImage(sprites.bush, d.x, d.y);
                    ctx.drawImage(sprites.bush, d.x+10, d.y);
                    ctx.drawImage(sprites.bush, d.x+20, d.y);
                }
            }
        });

        // 3. Disegna Mappa (Tile)
        let startCol = Math.floor(cameraX / TILE);
        let endCol = startCol + 22; // Disegna solo colonne visibili

        for(let x = startCol; x <= endCol; x++) {
            if(x < 0 || x >= 200) continue;
            for(let y = 0; y < 15; y++) {
                let t = map[x][y];
                if(t === 0) continue;
                
                if(t === 1) ctx.drawImage(sprites.ground, x*TILE, y*TILE);
                else if(t === 2) ctx.drawImage(sprites.box, x*TILE, y*TILE);
                else if(t === 3) ctx.drawImage(sprites.brick, x*TILE, y*TILE);
                else if(t === 4) { // Tubo Base
                    ctx.drawImage(sprites.pipe_bl, x*TILE, y*TILE); 
                    ctx.drawImage(sprites.pipe_br, (x+1)*TILE, y*TILE); 
                }
                else if(t === 5) { // Tubo Cima
                    ctx.drawImage(sprites.pipe_tl, x*TILE, y*TILE); 
                    ctx.drawImage(sprites.pipe_tr, (x+1)*TILE, y*TILE); 
                }
                else if(t === 8) ctx.drawImage(sprites.enemy, x*TILE, y*TILE);
            }
        }

        // 4. Disegna Mario
        ctx.save();
        ctx.translate(Math.floor(player.x) + 7, Math.floor(player.y) + 7);
        ctx.scale(player.facing, 1); 
        ctx.drawImage(sprites.mario, -8, -8);
        ctx.restore();

        ctx.restore();
        requestAnimationFrame(loop);
    }

    function loop() {
        update();
        draw();
    }

    // --- CONTROLLI ---
    window.addEventListener('keydown', e => {
        if(e.code === 'ArrowLeft') keys.left = true;
        if(e.code === 'ArrowRight') keys.right = true;
        if(e.code === 'Space' || e.code === 'KeyZ') keys.up = true;
        if(e.code === 'ShiftLeft') keys.run = true;
    });
    window.addEventListener('keyup', e => {
        if(e.code === 'ArrowLeft') keys.left = false;
        if(e.code === 'ArrowRight') keys.right = false;
        if(e.code === 'Space' || e.code === 'KeyZ') keys.up = false;
        if(e.code === 'ShiftLeft') keys.run = false;
    });

    const addTouch = (id, k) => {
        let el = document.getElementById(id);
        el.addEventListener('touchstart', e => { e.preventDefault(); keys[k] = true; });
        el.addEventListener('touchend', e => { e.preventDefault(); keys[k] = false; });
    };
    addTouch('left', 'left'); addTouch('right', 'right');
    addTouch('btnA', 'up'); addTouch('btnB', 'run'); addTouch('up', 'up');

    loop();

</script>
</body>
</html>
