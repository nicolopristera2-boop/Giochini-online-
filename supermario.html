<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Mario 8-Bit</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * { box-sizing: border-box; touch-action: none; user-select: none; }

        body { 
            margin: 0; padding: 0; 
            background-color: #101010; 
            font-family: 'Press Start 2P', cursive;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden; color: white;
        }

        /* --- STILE PC --- */
        canvas { 
            background-color: #5c94fc; /* Il classico Blu Mario */
            width: 800px; height: 600px;
            max-width: 100%; max-height: 100%;
            image-rendering: pixelated; /* FONDAMENTALE: rende i pixel nitidi */
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
            border: 4px solid #000;
        }

        #hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 800px; max-width: 90%;
            display: flex; justify-content: space-between;
            text-shadow: 2px 2px 0 #000; font-size: 16px; color: #fff; pointer-events: none;
            z-index: 10;
        }

        /* --- STILE MOBILE --- */
        .mobile-controls { display: none; }

        @media (max-width: 768px) {
            #hud { width: 90%; font-size: 10px; top: 10px; }
            
            body { background-color: #ddd; justify-content: flex-start; }
            
            .game-boy-case {
                width: 100%; height: 100dvh;
                display: flex; flex-direction: column;
                background: #f2f2f2;
            }

            .screen-wrapper {
                background: #777;
                padding: 15px 15px 0 15px;
                border-radius: 0 0 30px 30px;
                box-shadow: inset 0 -5px 10px rgba(0,0,0,0.2);
            }

            canvas {
                width: 100%; height: auto; aspect-ratio: 4/3;
                border: 4px solid #222; background-color: #5c94fc;
                box-shadow: none;
            }

            .mobile-controls {
                display: flex; flex: 1; justify-content: space-between; align-items: center; padding: 20px;
            }

            .d-pad { position: relative; width: 120px; height: 120px; }
            .btn-dir { position: absolute; background: #333; width: 40px; height: 40px; border-radius: 4px; box-shadow: 0 4px 0 #111; }
            .btn-dir:active { transform: translateY(4px); box-shadow: none; }
            #up { top:0; left:40px; } #down { bottom:0; left:40px; } #left { top:40px; left:0; } #right { top:40px; right:0; }

            .action-area { display: flex; gap: 15px; transform: rotate(-15deg); margin-right: 20px; }
            .btn-act { width: 55px; height: 55px; border-radius: 50%; background: #d00; border: none; box-shadow: 2px 4px 0 #800; color: rgba(0,0,0,0.3); font-weight: bold; font-size: 18px; }
            .btn-act:active { transform: translateY(4px); box-shadow: none; }
        }
    </style>
</head>
<body>

<div id="hud">
    <div>MARIO<br>000000</div>
    <div>COINS<br>ðŸŸ¡ <span id="coin-count">0</span></div>
    <div>WORLD<br>1-1</div>
    <div>TIME<br>âˆž</div>
</div>

<div class="game-boy-case">
    <div class="screen-wrapper">
        <canvas id="gameCanvas" width="320" height="240"></canvas>
    </div>
    <div class="mobile-controls">
        <div class="d-pad">
            <div class="btn-dir" id="up"></div>
            <div class="btn-dir" id="down"></div>
            <div class="btn-dir" id="left"></div>
            <div class="btn-dir" id="right"></div>
        </div>
        <div class="action-area">
            <button class="btn-act" id="btnB">B</button>
            <button class="btn-act" id="btnA">A</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- ASSETS GRAFICI (Base64 Pixel Art 16x16) ---
    // Questi codici generano le immagini stile NES
    const assets = {
        // Mario (Rosso/Marrone)
        mario: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAWklEQVQ4T2BkQAO/GTABRhL1YANGNvwHwf9oYsyA8THFRMvBqAEjIyOMj4yPLoguB5vCgM0AbApB5mAzAJtCkDlYDcAmT7Q5GAM2w/8z/E80wOhuJMkckgAAa242Eb864U4AAAAASUVORK5CYII=",
        // Terreno (Marrone con pattern)
        ground: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAARElEQVQ4T2NkwA7+M2wkBmD9j4ZHEmBkZCTWIGwAxqOQkcGMx424DMCmE6sQ2WJsBmMzFJsB2AzFZhA2A7HhPxr+JAYAAH1SDxF4f5WwAAAAAElFTkSuQmCC",
        // Mattone (Marrone scuro)
        brick: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAL0lEQVQ4T2NkwA7+M2wkBmD9j4ZHEmBkZCTWIGwAxqOQkcGMx424DMCmE6sQ2WIsADuSDxF1cQ3BAAAAAElFTkSuQmCC",
        // Box ? (Oro)
        box: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAATklEQVQ4T2NkwA7+M2wkBmD9j4ZHEmBkZCTWIGwAxqOQkcFvRiQ+VsXYDMZmKDYDsBmKzSBsBmLDf3QxQjEkBqB7kFj12DAxGDSQGADZsw8R99sMeAAAAABJRU5ErkJggg==",
        // Tubo (Verde)
        pipe: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAK0lEQVQ4T2NkQAP/Gf6jYyQBxqOQkcFvRgY0sBg1gGE0gGE0gGE0gIE0AAAj0Q8Rztus4wAAAABJRU5ErkJggg==",
        // Goomba (Nemico)
        enemy: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAATUlEQVQ4T2NkwA7+M2wkBmD9j4ZHEnjNwMDwH4oJMQAbG6sB2IyFqUe2GZsB2AzFZhA2A7HhPxr+JAYg+5A0w/CbkYGBgZGROANIBwAAo1QWEdul7TkAAAAASUVORK5CYII=",
        // Nuvola (Bianca per sfondo)
        cloud: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMklEQVQ4T2MQFhb+z0ACjI2N/zMh8VExdMDIyAgzBJsB2BRjMwCbQpA5WA3AJk+0ORgDAM8yJBFOpZ2OAAAAAElFTkSuQmCC",
        // Cespuglio (Verde per sfondo)
        bush: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAM0lEQVQ4T2NkwA7+M2wkBmDjY/qPhkcSYGRkJNYgbADGo5CRwW9GJD5WxdgMxmaroZEYAABO0Q0R/g+HwwAAAABJRU5ErkJggg=="
    };

    const sprites = {};
    let loadedCount = 0;
    const totalAssets = Object.keys(assets).length;

    // Caricatore Immagini
    for(let k in assets){
        let img = new Image();
        img.src = assets[k];
        img.onload = () => loadedCount++;
        sprites[k] = img;
    }

    // --- GAME ENGINE ---
    const TILE = 16;
    let player = { x: 50, y: 100, w: 14, h: 14, vx: 0, vy: 0, grounded: false, facing: 1, coins: 0 };
    let cameraX = 0;
    let keys = { left: false, right: false, up: false, run: false };
    
    // Mappa generata proceduralmente
    let map = [];
    let decor = []; // Nuvole e cespugli

    function initMap() {
        // Genera 200 colonne
        for(let x=0; x<200; x++) {
            let col = new Array(15).fill(0);
            
            // Pavimento (ultime 2 righe)
            col[13] = 1; col[14] = 1; 

            // Buchi nel pavimento
            if(x > 50 && x < 53) { col[13] = 0; col[14] = 0; }
            if(x > 80 && x < 85) { col[13] = 0; col[14] = 0; }

            // Blocchi e Tubi
            if(x > 10 && x < 200) {
                let r = Math.random();
                if(r > 0.95) col[9] = 2; // Box ?
                else if(r > 0.90) col[9] = 3; // Mattone
                
                // Tubi (Altezza variabile)
                if(x % 30 === 0 && x > 20) {
                    col[12] = 4; col[11] = 4; // Tubo alto 2
                    if(Math.random() > 0.5) col[10] = 4; // Tubo alto 3
                }

                // Nemici
                if(x > 20 && r > 0.97 && col[13] === 1) {
                    col[12] = 5; // Goomba a terra
                }
            }
            map.push(col);

            // Genera Decorazioni Sfondo (Nuvole/Cespugli)
            if(Math.random() > 0.90) decor.push({x: x*TILE, y: (Math.random()*100)+20, type: 'cloud'});
            if(Math.random() > 0.92) decor.push({x: x*TILE, y: 12*TILE, type: 'bush'});
        }
        // Muri inizio/fine
        map[0][12] = 4; map[199][12] = 4; 
    }
    initMap();

    // Loop Fisica
    function update() {
        // Input
        if(keys.left) { player.vx -= 0.5; player.facing = -1; }
        if(keys.right) { player.vx += 0.5; player.facing = 1; }
        
        // Attrito
        player.vx *= 0.85;
        let maxSpeed = keys.run ? 3.5 : 2.0;
        if(player.vx > maxSpeed) player.vx = maxSpeed;
        if(player.vx < -maxSpeed) player.vx = -maxSpeed;

        // GravitÃ 
        player.vy += 0.25;

        // Salto
        if(keys.up && player.grounded) {
            player.vy = -6.5;
            player.grounded = false;
        }

        // Applicazione X
        player.x += player.vx;
        checkCollision(true);

        // Applicazione Y
        player.y += player.vy;
        player.grounded = false;
        checkCollision(false);

        // Morte caduta
        if(player.y > 250) {
            player.x = 50; player.y = 100; player.vy = 0; // Respawn
        }

        // Camera Follow
        let targetCam = player.x - 120;
        if(targetCam < 0) targetCam = 0;
        cameraX += (targetCam - cameraX) * 0.1;
    }

    function checkCollision(isX) {
        let startX = Math.floor(player.x / TILE);
        let endX = Math.floor((player.x + player.w) / TILE);
        let startY = Math.floor(player.y / TILE);
        let endY = Math.floor((player.y + player.h) / TILE);

        for(let y = startY; y <= endY; y++) {
            for(let x = startX; x <= endX; x++) {
                if(x < 0 || x >= 200 || y < 0 || y >= 15) continue;
                
                let tile = map[x][y];
                if(tile === 1 || tile === 2 || tile === 3 || tile === 4) { // Solidi
                    if(isX) {
                        if(player.vx > 0) player.x = x * TILE - player.w - 0.1;
                        else if(player.vx < 0) player.x = (x + 1) * TILE + 0.1;
                        player.vx = 0;
                    } else {
                        if(player.vy > 0) {
                            player.y = y * TILE - player.h - 0.1;
                            player.vy = 0;
                            player.grounded = true;
                        } else if(player.vy < 0) {
                            player.y = (y + 1) * TILE + 0.1;
                            player.vy = 0;
                            // Colpisci blocco ?
                            if(tile === 2) {
                                map[x][y] = 3; // Diventa mattone
                                player.coins++;
                                document.getElementById('coin-count').innerText = player.coins;
                            }
                        }
                    }
                }
            }
        }
    }

    function draw() {
        // 1. Cielo Azzurro
        ctx.fillStyle = "#5c94fc";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(-Math.floor(cameraX), 0);

        // 2. Disegna Sfondo (Nuvole/Cespugli)
        decor.forEach(d => {
            if(d.x > cameraX - 50 && d.x < cameraX + 350) {
                if(d.type === 'cloud') ctx.drawImage(sprites.cloud, d.x, d.y, 32, 16); // Nuvole piÃ¹ larghe
                if(d.type === 'bush') ctx.drawImage(sprites.bush, d.x, d.y, 32, 16);
            }
        });

        // 3. Disegna Mappa (Tile)
        let startCol = Math.floor(cameraX / TILE);
        let endCol = startCol + 22; // Disegna solo colonne visibili

        for(let x = startCol; x <= endCol; x++) {
            if(x < 0 || x >= 200) continue;
            for(let y = 0; y < 15; y++) {
                let t = map[x][y];
                if(t === 0) continue;
                
                let img = null;
                if(t === 1) img = sprites.ground;
                else if(t === 2) img = sprites.box;
                else if(t === 3) img = sprites.brick;
                else if(t === 4) img = sprites.pipe;
                else if(t === 5) img = sprites.enemy;

                if(img && img.complete) {
                    ctx.drawImage(img, x*TILE, y*TILE, TILE, TILE);
                } else {
                    // Fallback se immagine non carica (non dovrebbe succedere)
                    ctx.fillStyle = "#000"; ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
                }
            }
        }

        // 4. Disegna Mario
        ctx.save();
        ctx.translate(Math.floor(player.x) + 7, Math.floor(player.y) + 7);
        ctx.scale(player.facing, 1); // Flip orizzontale
        if(sprites.mario.complete) ctx.drawImage(sprites.mario, -8, -8, 16, 16);
        else { ctx.fillStyle = "red"; ctx.fillRect(-7,-7,14,14); }
        ctx.restore();

        ctx.restore();
        requestAnimationFrame(loop);
    }

    function loop() {
        update();
        draw();
    }

    // --- CONTROLLI ---
    // Tastiera
    window.addEventListener('keydown', e => {
        if(e.code === 'ArrowLeft') keys.left = true;
        if(e.code === 'ArrowRight') keys.right = true;
        if(e.code === 'Space' || e.code === 'KeyZ') keys.up = true;
        if(e.code === 'ShiftLeft') keys.run = true;
    });
    window.addEventListener('keyup', e => {
        if(e.code === 'ArrowLeft') keys.left = false;
        if(e.code === 'ArrowRight') keys.right = false;
        if(e.code === 'Space' || e.code === 'KeyZ') keys.up = false;
        if(e.code === 'ShiftLeft') keys.run = false;
    });

    // Touch (Mobile)
    const addTouch = (id, k) => {
        let el = document.getElementById(id);
        el.addEventListener('touchstart', e => { e.preventDefault(); keys[k] = true; });
        el.addEventListener('touchend', e => { e.preventDefault(); keys[k] = false; });
    };
    addTouch('left', 'left'); addTouch('right', 'right');
    addTouch('btnA', 'up'); addTouch('btnB', 'run'); addTouch('up', 'up');

    // Avvio
    loop();

</script>
</body>
</html>
