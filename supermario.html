<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Mario Fix - Enemies & Story</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * { box-sizing: border-box; touch-action: none; user-select: none; }

        body { 
            margin: 0; padding: 0; 
            background-color: #1a1a1a; 
            font-family: 'Press Start 2P', cursive;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden; color: white;
        }

        canvas { 
            background-color: #6b8cff;
            width: 800px; height: 600px;
            max-width: 100%; max-height: 100%;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border-radius: 4px;
        }

        #hud {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            width: 800px; max-width: 90%;
            display: flex; justify-content: space-between;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8); font-size: 16px; color: #fff; pointer-events: none;
            z-index: 10;
        }

        /* Schermata Iniziale Overlay */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; text-align: center; padding: 20px;
        }
        .hidden { display: none !important; }
        h1 { color: #ff4d4d; text-shadow: 4px 4px 0 #000; margin-bottom: 20px; font-size: 40px; }
        p { line-height: 1.8; color: #ddd; font-size: 14px; max-width: 600px; margin-bottom: 30px; }
        .blink { animation: blinker 1s linear infinite; color: #FFD700; font-size: 18px; margin-top: 20px;}
        @keyframes blinker { 50% { opacity: 0; } }

        /* Controlli Mobile */
        .mobile-controls { display: none; }
        @media (max-width: 768px) {
            #hud { width: 90%; font-size: 10px; top: 10px; }
            body { background-color: #222; justify-content: flex-start; }
            h1 { font-size: 24px; }
            .game-boy-case { width: 100%; height: 100dvh; display: flex; flex-direction: column; background: #f2f2f2; }
            .screen-wrapper { background: #111; padding: 10px; display: flex; justify-content: center; }
            canvas { width: 100%; height: auto; aspect-ratio: 4/3; border: 2px solid #333; }
            .mobile-controls { display: flex; flex: 1; justify-content: space-between; align-items: center; padding: 20px; background: #e0e0e0; }
            .d-pad { position: relative; width: 140px; height: 140px; }
            .btn-dir { position: absolute; background: #333; width: 45px; height: 45px; border-radius: 6px; box-shadow: 0 4px 0 #111; }
            .btn-dir:active { transform: translateY(4px); box-shadow: none; background: #555; }
            #up { top:0; left:47px; } #down { bottom:0; left:47px; } #left { top:47px; left:0; } #right { top:47px; right:0; }
            .action-area { display: flex; gap: 20px; transform: rotate(-10deg); margin-right: 20px; }
            .btn-act { width: 60px; height: 60px; border-radius: 50%; background: #d00; border: 2px solid #900; box-shadow: 2px 4px 0 #600; color: white; font-weight: bold; }
            .btn-act:active { transform: translateY(4px); box-shadow: none; }
        }
    </style>
</head>
<body>

<div id="start-screen">
    <h1>SUPER MARIO<br>JS EDITION</h1>
    <p>
        Il regno dei funghi Ã¨ in pericolo! Il malvagio Browser ha rubato tutto il codice sorgente.<br><br>
        Devi attraversare la valle glitchata, saltare sopra il Grande Burrone e sconfiggere i Goomba corrotti per salvare la Principessa Script.<br><br>
        Attento: I tubi sono bloccati dalla ruggine!
    </p>
    <div class="blink">PREMI SPAZIO O TOCCA PER INIZIARE</div>
</div>

<div id="hud">
    <div>MARIO<br>000000</div>
    <div>COINS<br>ðŸŸ¡ <span id="coin-count">0</span></div>
    <div>WORLD<br>1-1</div>
</div>

<div class="game-boy-case">
    <div class="screen-wrapper">
        <canvas id="gameCanvas" width="320" height="240"></canvas>
    </div>
    <div class="mobile-controls">
        <div class="d-pad">
            <div class="btn-dir" id="up"></div>
            <div class="btn-dir" id="down"></div>
            <div class="btn-dir" id="left"></div>
            <div class="btn-dir" id="right"></div>
        </div>
        <div class="action-area">
            <button class="btn-act" id="btnB">Run</button>
            <button class="btn-act" id="btnA">Jump</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const startScreen = document.getElementById('start-screen');

    // --- GAME STATES ---
    let gameState = 'START'; // START, PLAYING, GAMEOVER

    // --- ASSETS GENERATOR ---
    const sprites = {};
    const TILE = 16;

    function createHDAsset(type) {
        const c = document.createElement('canvas');
        c.width = TILE; c.height = TILE;
        const x = c.getContext('2d');
        
        if (type === 'ground') {
            x.fillStyle = "#8B4513"; x.fillRect(0, 0, 16, 16);
            x.fillStyle = "#228B22"; x.fillRect(0, 0, 16, 4);
            x.fillStyle = "#32CD32"; x.fillRect(0, 0, 16, 1);
            x.fillStyle = "rgba(0,0,0,0.3)"; x.fillRect(3, 8, 2, 2); x.fillRect(10, 12, 3, 2);
        } else if (type === 'brick') {
            x.fillStyle = "#B22222"; x.fillRect(0, 0, 16, 16);
            x.fillStyle = "#000"; x.fillRect(0, 7, 16, 2); x.fillRect(7, 0, 2, 8); x.fillRect(7, 9, 2, 7);
        } else if (type === 'box') {
            x.fillStyle = "#FFD700"; x.fillRect(0, 0, 16, 16);
            x.fillStyle = "#8B4513"; x.fillRect(1,1,2,2); x.fillRect(13,1,2,2); x.fillRect(1,13,2,2); x.fillRect(13,13,2,2);
            x.fillStyle = "#FFF"; x.font = "bold 14px monospace"; x.fillText("?", 4, 13);
        } else if (type.includes('pipe')) {
            let grad = x.createLinearGradient(0,0,16,0);
            grad.addColorStop(0, "#006400"); grad.addColorStop(0.2, "#32CD32"); grad.addColorStop(1, "#006400");
            x.fillStyle = grad;
            if(type === 'pipe_tl') { x.fillRect(0,0,16,16); x.fillStyle="#004400"; x.fillRect(0,14,16,2); }
            if(type === 'pipe_tr') { x.fillRect(0,0,16,16); x.fillStyle="#004400"; x.fillRect(0,14,16,2); }
            if(type === 'pipe_bl') { x.fillRect(2,0,14,16); }
            if(type === 'pipe_br') { x.fillRect(0,0,14,16); }
        }
        return c;
    }

    sprites.ground = createHDAsset('ground');
    sprites.brick = createHDAsset('brick');
    sprites.box = createHDAsset('box');
    sprites.pipe_tl = createHDAsset('pipe_tl');
    sprites.pipe_tr = createHDAsset('pipe_tr');
    sprites.pipe_bl = createHDAsset('pipe_bl');
    sprites.pipe_br = createHDAsset('pipe_br');

    // --- ENTITIES & CLASSES ---
    
    // Nemico (Goomba)
    class Goomba {
        constructor(x, y) {
            this.x = x; this.y = y; this.w = 16; this.h = 16;
            this.vx = -0.5; this.vy = 0;
            this.dead = false;
        }
        update(map) {
            if(this.dead) return;
            
            // Movimento semplice AI
            this.vy += 0.25; // GravitÃ 
            this.x += this.vx;
            
            // Collisione orizzontale Muri
            let tileX = this.vx > 0 ? Math.floor((this.x + this.w)/TILE) : Math.floor(this.x/TILE);
            let tileY = Math.floor(this.y/TILE);
            if(map[tileX] && map[tileX][tileY] > 0) {
                this.vx *= -1; // Inverti direzione
            }

            // Movimento Y
            this.y += this.vy;
            let groundX = Math.floor((this.x + 8)/TILE);
            let groundY = Math.floor((this.y + this.h)/TILE);
            
            if(map[groundX] && map[groundX][groundY] > 0) {
                this.y = groundY * TILE - this.h;
                this.vy = 0;
            }

            // Cade nel vuoto
            if(this.y > 300) this.dead = true;
        }
        draw(ctx) {
            if(this.dead) return;
            ctx.fillStyle = "#8B4500";
            ctx.beginPath(); ctx.arc(this.x + 8, this.y + 8, 7, 0, Math.PI*2); ctx.fill();
            // Faccia incazzata
            ctx.fillStyle = "#fff"; ctx.fillRect(this.x+2, this.y+4, 4, 3); ctx.fillRect(this.x+10, this.y+4, 4, 3);
            ctx.fillStyle = "#000"; ctx.fillRect(this.x+4, this.y+5, 1, 2); ctx.fillRect(this.x+12, this.y+5, 1, 2);
            // Piedi animati
            let footOffset = Math.sin(Date.now()/100) * 2;
            ctx.fillStyle = "black"; 
            ctx.fillRect(this.x+2 + footOffset, this.y+13, 5, 3); 
            ctx.fillRect(this.x+9 - footOffset, this.y+13, 5, 3);
        }
    }

    let enemies = [];
    let player = { x: 50, y: 100, w: 12, h: 14, vx: 0, vy: 0, grounded: false, facing: 1, coins: 0 };
    let cameraX = 0;
    let map = [];
    let keys = { left: false, right: false, up: false, run: false };

    // --- LEVEL GENERATION (FIXED) ---
    function initGame() {
        player.x = 50; player.y = 100; player.vx = 0; player.vy = 0;
        cameraX = 0;
        enemies = [];
        map = [];
        
        for(let x=0; x<220; x++) {
            let col = new Array(15).fill(0);
            
            // Pavimento (con buchi)
            col[13] = 1; col[14] = 1; 
            
            // IL GRANDE BURRONE (x: 70-75)
            if(x >= 70 && x <= 75) { 
                col[13] = 0; col[14] = 0; 
                // FIX: Aggiunti blocchi galleggianti sopra il burrone
                if(x === 71 || x === 73 || x === 74) col[9] = 3; 
            }

            // Piattaforme e Ostacoli
            if(x > 10 && x < 210) {
                // Blocchi casuali
                if(Math.random() > 0.90 && col[13] === 1) col[9] = (Math.random()>0.5 ? 2 : 3);
                
                // Tubi (Solidi)
                if(x % 50 === 0 && x > 20) {
                    col[12] = 4; col[11] = 4; col[10] = 5; // Tubo alto 3 blocchi
                }

                // Generazione Nemici (NON PIÃ™ COME TILE, MA OGGETTI)
                if(x > 30 && x < 200 && x % 25 === 0 && col[13]===1) {
                    enemies.push(new Goomba(x*TILE, 10*TILE));
                }
            }
            // Fine livello (Muro)
            if(x > 215) { col[12]=3; col[11]=3; col[10]=3; }
            
            map.push(col);
        }
    }

    // --- GAME LOOP ---
    function update() {
        if(gameState !== 'PLAYING') return;

        // Player Physics
        if(keys.left) { player.vx -= 0.5; player.facing = -1; }
        if(keys.right) { player.vx += 0.5; player.facing = 1; }
        player.vx *= 0.85;
        player.vy += 0.25;

        if(keys.up && player.grounded) {
            player.vy = -6.8; // Salto leggermente piÃ¹ alto per il burrone
            player.grounded = false;
        }

        player.x += player.vx;
        checkCollision(true);
        player.y += player.vy;
        player.grounded = false;
        checkCollision(false);

        // Morte nel Burrone
        if(player.y > 250) gameOver();

        // Update Camera
        let targetCam = player.x - 120;
        if(targetCam < 0) targetCam = 0;
        cameraX += (targetCam - cameraX) * 0.1;

        // UPDATE NEMICI & COLLISIONE CON MARIO
        enemies.forEach(e => {
            e.update(map);
            
            if(!e.dead) {
                // Controllo collisione rettangolare semplice
                if (player.x < e.x + e.w &&
                    player.x + player.w > e.x &&
                    player.y < e.y + e.h &&
                    player.y + player.h > e.y) {
                    
                    // Se Mario sta cadendo e colpisce dall'alto
                    if (player.vy > 0 && player.y + player.h - player.vy <= e.y + e.h * 0.5) {
                        e.dead = true; // Uccidi nemico
                        player.vy = -3; // Rimbalzo
                        player.coins += 10;
                    } else {
                        // Colpito di lato o da sotto -> Morte Mario
                        gameOver();
                    }
                }
            }
        });
    }

    function checkCollision(isX) {
        let startX = Math.floor(player.x / TILE);
        let endX = Math.floor((player.x + player.w) / TILE);
        let startY = Math.floor(player.y / TILE);
        let endY = Math.floor((player.y + player.h) / TILE);

        for(let y = startY; y <= endY; y++) {
            for(let x = startX; x <= endX; x++) {
                if(x < 0 || x >= map.length || y < 0 || y >= 15) continue;
                
                let tile = map[x][y];
                // 1=Terra, 2=Box, 3=Brick, 4/5=Tubo (ORA TUTTI SOLIDI)
                if(tile >= 1 && tile <= 7) { 
                    if(isX) {
                        if(player.vx > 0) player.x = x * TILE - player.w - 0.1;
                        else if(player.vx < 0) player.x = (x + 1) * TILE + 0.1;
                        player.vx = 0;
                    } else {
                        if(player.vy > 0) {
                            player.y = y * TILE - player.h - 0.1;
                            player.vy = 0;
                            player.grounded = true;
                        } else if(player.vy < 0) {
                            player.y = (y + 1) * TILE + 0.1;
                            player.vy = 0;
                            if(tile === 2) { 
                                map[x][y] = 3; player.coins++; 
                                document.getElementById('coin-count').innerText = player.coins;
                            }
                        }
                    }
                }
            }
        }
    }

    function gameOver() {
        alert("GAME OVER! Hai perso una vita.");
        initGame(); // Ricomincia
    }

    function draw() {
        // Cielo
        let skyGrad = ctx.createLinearGradient(0, 0, 0, 240);
        skyGrad.addColorStop(0, "#4facfe"); skyGrad.addColorStop(1, "#00f2fe");
        ctx.fillStyle = skyGrad; ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(-Math.floor(cameraX), 0);

        // Disegna Mappa
        let startCol = Math.floor(cameraX / TILE);
        let endCol = startCol + 22;

        for(let x = startCol; x <= endCol; x++) {
            if(x < 0 || x >= map.length) continue;
            for(let y = 0; y < 15; y++) {
                let t = map[x][y];
                if(t === 1) ctx.drawImage(sprites.ground, x*TILE, y*TILE);
                else if(t === 2) ctx.drawImage(sprites.box, x*TILE, y*TILE);
                else if(t === 3) ctx.drawImage(sprites.brick, x*TILE, y*TILE);
                else if(t === 4) { ctx.drawImage(sprites.pipe_bl, x*TILE, y*TILE); ctx.drawImage(sprites.pipe_br, (x+1)*TILE, y*TILE); }
                else if(t === 5) { ctx.drawImage(sprites.pipe_tl, x*TILE, y*TILE); ctx.drawImage(sprites.pipe_tr, (x+1)*TILE, y*TILE); }
            }
        }

        // Disegna Nemici
        enemies.forEach(e => e.draw(ctx));

        // Disegna Mario
        ctx.translate(player.x + player.w/2, player.y + player.h/2);
        ctx.scale(player.facing, 1);
        
        // Sprite Mario Semplice
        ctx.fillStyle = "red"; ctx.fillRect(-6, -6, 12, 6); // Cappello
        ctx.fillStyle = "blue"; ctx.fillRect(-5, 0, 10, 8); // Tuta
        ctx.fillStyle = "#FFCC99"; ctx.fillRect(-5, -5, 8, 5); // Faccia
        
        ctx.restore();
        requestAnimationFrame(loop);
    }

    function loop() {
        update();
        draw();
    }

    // --- INPUT ---
    function startGameInput() {
        if(gameState === 'START') {
            gameState = 'PLAYING';
            startScreen.classList.add('hidden');
            initGame();
        }
    }

    window.addEventListener('keydown', e => {
        if(gameState === 'START' && e.code === 'Space') startGameInput();
        if(e.code === 'ArrowLeft') keys.left = true;
        if(e.code === 'ArrowRight') keys.right = true;
        if(e.code === 'Space' || e.code === 'KeyZ') keys.up = true;
    });
    window.addEventListener('keyup', e => {
        if(e.code === 'ArrowLeft') keys.left = false;
        if(e.code === 'ArrowRight') keys.right = false;
        if(e.code === 'Space' || e.code === 'KeyZ') keys.up = false;
    });
    
    // Touch Start
    startScreen.addEventListener('touchstart', startGameInput);
    
    // Controlli touch game
    const addTouch = (id, k) => {
        let el = document.getElementById(id);
        el.addEventListener('touchstart', e => { e.preventDefault(); keys[k] = true; });
        el.addEventListener('touchend', e => { e.preventDefault(); keys[k] = false; });
    };
    addTouch('left', 'left'); addTouch('right', 'right');
    addTouch('btnA', 'up'); addTouch('up', 'up');

    // Avvio
    loop();

</script>
</body>
</html>
