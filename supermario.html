<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Mario Simple</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * { box-sizing: border-box; touch-action: none; user-select: none; }

        body { 
            margin: 0; padding: 0; 
            background-color: #202020; /* Grigio scuro per la pagina */
            font-family: 'Press Start 2P', cursive;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; overflow: hidden; color: white;
        }

        /* --- STILE DEL GIOCO (PC) --- */
        canvas { 
            /* FORZIAMO IL CIELO AZZURRO DAL CSS */
            background-color: #5c94fc; 
            width: 800px;
            height: 600px;
            max-width: 100%;
            max-height: 100%;
            image-rendering: pixelated;
            border: 4px solid #fff; /* Bordo bianco per vedere dove finisce il gioco */
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            display: block;
        }

        /* HUD PC */
        #pc-hud {
            width: 800px; max-width: 90%;
            display: flex; justify-content: space-between;
            margin-bottom: 10px;
            text-shadow: 2px 2px 0 #000;
            font-size: 16px;
            color: #fff;
        }

        /* Nascondi controlli mobile su PC */
        .mobile-controls { display: none; }

        /* --- STILE MOBILE --- */
        @media (max-width: 768px) {
            #pc-hud { display: none; }
            
            body { background-color: #f7f7f7; justify-content: flex-start; }

            .game-container {
                width: 100%; height: 100dvh;
                display: flex; flex-direction: column;
            }

            .screen-area {
                background: #555;
                padding: 20px;
                border-radius: 0 0 40px 0;
                box-shadow: inset 2px 2px 5px rgba(0,0,0,0.5);
            }

            canvas {
                width: 100%; height: auto; aspect-ratio: 4/3;
                border: 4px solid #222;
                background-color: #5c94fc;
            }

            .mobile-controls {
                display: flex; flex: 1;
                justify-content: space-between; align-items: center;
                padding: 20px;
            }

            .d-pad { position: relative; width: 120px; height: 120px; }
            .btn { position: absolute; background: #222; width: 40px; height: 40px; border-radius: 4px; }
            .btn:active { background: #555; }
            #up { top:0; left:40px; }
            #down { bottom:0; left:40px; }
            #left { top:40px; left:0; }
            #right { top:40px; right:0; }

            .action-btns { display: flex; gap: 20px; transform: rotate(-15deg); }
            .round-btn { width: 60px; height: 60px; border-radius: 50%; background: #d32f2f; border: none; color:rgba(0,0,0,0.2); font-weight:bold; font-size:20px; box-shadow: 2px 3px 0 #800; }
            .round-btn:active { transform: translateY(3px); box-shadow: none; }
        }
    </style>
</head>
<body>

<div id="pc-hud">
    <div>MARIO x 3</div>
    <div style="font-size: 10px; color:#ddd; padding-top:5px;">FRECCE + SPAZIO</div>
    <div id="score">MONETE: 0</div>
</div>

<div class="game-container">
    <div class="screen-area">
        <canvas id="gameCanvas" width="320" height="240"></canvas>
    </div>

    <div class="mobile-controls">
        <div class="d-pad">
            <div class="btn" id="up"></div>
            <div class="btn" id="down"></div>
            <div class="btn" id="left"></div>
            <div class="btn" id="right"></div>
        </div>
        <div class="action-btns">
            <button class="round-btn" id="btnB">B</button>
            <button class="round-btn" id="btnA">A</button>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- VARIABILI ---
    const TILE = 16;
    let player = { x: 50, y: 100, w: 16, h: 16, vx: 0, vy: 0, grounded: false, color: 'red' };
    let coins = 0;
    let cameraX = 0;
    let keys = { left: false, right: false, up: false };
    
    // Mappa semplice (1 = terra, 2 = box moneta, 3 = mattone)
    let map = [];
    for(let y=0; y<15; y++) {
        let row = [];
        for(let x=0; x<100; x++) {
            if(y >= 13) row.push(1); // Pavimento
            else if(x===0 || x===99) row.push(1); // Muri
            else if(y===9 && x>10 && x<15) row.push(2); // Box
            else if(y===9 && x===16) row.push(3); // Mattone
            else row.push(0); // Aria
        }
        map.push(row);
    }

    // --- LOOP DI GIOCO ---
    function update() {
        // Movimento Orizzontale
        if(keys.left) player.vx -= 0.5;
        if(keys.right) player.vx += 0.5;
        player.vx *= 0.8; // Attrito

        // Gravità
        player.vy += 0.3; 
        
        // Salto
        if(keys.up && player.grounded) {
            player.vy = -6;
            player.grounded = false;
        }

        // Applica velocità
        player.x += player.vx;
        checkCollision(true); // Controllo X
        player.y += player.vy;
        player.grounded = false;
        checkCollision(false); // Controllo Y

        // Morte caduta
        if(player.y > 300) { player.x = 50; player.y = 100; player.vy = 0; }

        // Camera
        cameraX = player.x - 100;
        if(cameraX < 0) cameraX = 0;
    }

    function checkCollision(isX) {
        // Indici della griglia
        let left = Math.floor(player.x / TILE);
        let right = Math.floor((player.x + player.w - 0.1) / TILE);
        let top = Math.floor(player.y / TILE);
        let bottom = Math.floor((player.y + player.h - 0.1) / TILE);

        // Controlla i 4 angoli
        let tl = getTile(left, top);
        let tr = getTile(right, top);
        let bl = getTile(left, bottom);
        let br = getTile(right, bottom);

        if(isX) {
            if (player.vx > 0) { // Destra
                if (tr || br) { player.x = (right * TILE) - player.w; player.vx = 0; }
            } else if (player.vx < 0) { // Sinistra
                if (tl || bl) { player.x = (left + 1) * TILE; player.vx = 0; }
            }
        } else {
            if (player.vy > 0) { // Caduta
                if (bl || br) { 
                    player.y = (bottom * TILE) - player.h; 
                    player.vy = 0; 
                    player.grounded = true; 
                }
            } else if (player.vy < 0) { // Salto
                if (tl || tr) { 
                    player.y = (top + 1) * TILE; 
                    player.vy = 0; 
                    if(tr === 2 || tl === 2) { // Colpisci Box
                         coins++; 
                         document.getElementById('score').innerText = "MONETE: " + coins;
                         // Cambia tile a usata (opzionale)
                    }
                }
            }
        }
    }

    function getTile(x, y) {
        if(y < 0 || y >= 15 || x < 0 || x >= 100) return 0;
        return map[y][x];
    }

    function draw() {
        // Pulisci e disegna cielo
        ctx.fillStyle = "#5c94fc";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(-Math.floor(cameraX), 0);

        // Disegna Mappa
        for(let y=0; y<15; y++) {
            // Disegna solo le tile visibili
            let startX = Math.floor(cameraX / TILE);
            for(let x=startX; x<startX+25; x++) {
                let t = getTile(x, y);
                if(t === 1) { // Terra
                    ctx.fillStyle = "#8B4513"; // Marrone
                    ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
                    ctx.fillStyle = "#228B22"; // Erba sopra
                    ctx.fillRect(x*TILE, y*TILE, TILE, 4);
                } else if(t === 2) { // Box Moneta
                    ctx.fillStyle = "gold";
                    ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
                    ctx.strokeRect(x*TILE, y*TILE, TILE, TILE);
                    ctx.fillStyle = "black"; ctx.font="10px Arial"; ctx.fillText("?", x*TILE+4, y*TILE+12);
                } else if(t === 3) { // Mattone
                    ctx.fillStyle = "#A0522D";
                    ctx.fillRect(x*TILE, y*TILE, TILE, TILE);
                    ctx.strokeRect(x*TILE, y*TILE, TILE, TILE);
                }
            }
        }

        // Disegna Player
        ctx.fillStyle = player.color;
        ctx.fillRect(player.x, player.y, player.w, player.h);
        
        // Occhi (per capire direzione)
        ctx.fillStyle = "white";
        if(keys.left) ctx.fillRect(player.x+2, player.y+4, 4, 4);
        else ctx.fillRect(player.x+10, player.y+4, 4, 4);

        ctx.restore();

        requestAnimationFrame(update);
        requestAnimationFrame(draw);
    }

    // --- CONTROLLI ---
    window.addEventListener('keydown', e => {
        if(e.code === 'ArrowLeft') keys.left = true;
        if(e.code === 'ArrowRight') keys.right = true;
        if(e.code === 'Space') keys.up = true;
    });
    window.addEventListener('keyup', e => {
        if(e.code === 'ArrowLeft') keys.left = false;
        if(e.code === 'ArrowRight') keys.right = false;
        if(e.code === 'Space') keys.up = false;
    });
    
    // Controlli Touch
    const bindTouch = (id, key) => {
        const el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('touchstart', (e) => { e.preventDefault(); if(key==='up') keys.up=true; else if(key==='left') keys.left=true; else if(key==='right') keys.right=true; });
        el.addEventListener('touchend', (e) => { e.preventDefault(); if(key==='up') keys.up=false; else if(key==='left') keys.left=false; else if(key==='right') keys.right=false; });
    };
    bindTouch('btnA', 'up'); bindTouch('left', 'left'); bindTouch('right', 'right'); bindTouch('up', 'up');

    // Avvio
    draw();

</script>
</body>
</html>
